<!doctype html>
<html lang="th">

<head>
    <meta charset="utf-8" />
    <title>ESP32 Images</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <style>
        body { background:#f3f4f6; padding:24px; font-family: Arial;}
        h1 { font-size:22px; font-weight:700; color:#1e40af; text-align:center; margin-bottom:50px; }

        .grid {
            display:grid;
            grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
            gap:20px;
            max-width:1400px;
            margin:0 auto;
        }
        .card { background:white; border-radius:12px; overflow:hidden; box-shadow:0 6px 18px rgba(0,0,0,0.06); cursor:pointer; }
        .thumb { width:100%; aspect-ratio:16/9; object-fit:cover; background:#ddd; }
        .meta { padding:10px 14px; }
        .title { font-weight:600; font-size:15px; }
        .stats { font-size:12px; color:#64748b; margin-top:4px; }

        /* Popup preview */
        #previewOverlay {
            position: fixed; top:0; left:0; width:100%; height:100%;
            background: rgba(0,0,0,0.8); display:none; justify-content:center; align-items:center; z-index:50;
        }
        #previewOverlay img { max-width:90%; max-height:90%; border-radius:12px; }
        #previewOverlay span { position:absolute; top:20px; right:30px; color:white; font-size:30px; cursor:pointer; }

  /* Sidebar */
  #sidebar {
    position: fixed;
    top: 0;
    left: -260px;
    width: 260px;
    height: 100%;
    background: white;
    box-shadow: 3px 0 12px rgba(0,0,0,0.15);
    padding: 20px;
    z-index: 60;
    transition: left 0.3s ease;
  }

  #sidebar.active { left: 0; }

  #closeSidebarX {
      position: absolute;
      top: 12px;
      right: 18px;
      font-size: 36px;
      cursor: pointer;
      color: #333;
      font-weight: bold;
  }

  #overlayBg {
      position: fixed;
      top:0; left:0;
      width:100%; height:100%;
      background: rgba(0,0,0,0.4);
      display:none;
      z-index:55;
  }

  #sidebar a {
      position: relative;
      text-decoration: none;
  }

  #sidebar a::after {
      content: "";
      position: absolute;
      left: 0;
      bottom: -2px;
      width: 0%;
      height: 2px;
      background: #1e40af;
      transition: 0.25s ease;
  }

  #sidebar a:hover::after {
      width: 100%;
  }

  .sidebar-divider {
      width: 100%;
      height: 1px;
      background: #e5e7eb;
      margin: 20px 0;
  }

  /* -------------------------
   Uiverse Switch Style
------------------------- */
.switch {
  font-size: 17px;
  position: relative;
  display: inline-block;
  width: 5em;
  height: 2.5em;
  user-select: none;
}

.switch .cb {
  opacity: 0;
  width: 0;
  height: 0;
}

.toggle {
  position: absolute;
  cursor: pointer;
  width: 100%;
  height: 100%;
  background-color: #373737;
  border-radius: 0.1em;
  transition: 0.4s;
  text-transform: uppercase;
  font-weight: 700;
  overflow: hidden;
  box-shadow: -0.3em 0 0 0 #373737, -0.3em 0.3em 0 0 #373737,
    0.3em 0 0 0 #373737, 0.3em 0.3em 0 0 #373737, 0 0.3em 0 0 #373737;
}

.toggle > .left {
  position: absolute;
  display: flex;
  width: 50%;
  height: 88%;
  background-color: #f3f3f3;
  color: #373737;
  left: 0;
  bottom: 0;
  align-items: center;
  justify-content: center;
  transform-origin: right;
  transform: rotateX(10deg);
  transform-style: preserve-3d;
  transition: all 150ms;
}

.left::before {
  position: absolute;
  content: "";
  width: 100%;
  height: 100%;
  background-color: rgb(206, 206, 206);
  transform-origin: center left;
  transform: rotateY(90deg);
}

.left::after {
  position: absolute;
  content: "";
  width: 100%;
  height: 100%;
  background-color: rgb(112, 112, 112);
  transform-origin: center bottom;
  transform: rotateX(90deg);
}

.toggle > .right {
  position: absolute;
  display: flex;
  width: 50%;
  height: 88%;
  background-color: #f3f3f3;
  color: rgb(206, 206, 206);
  right: 1px;
  bottom: 0;
  align-items: center;
  justify-content: center;
  transform-origin: left;
  transform: rotateX(10deg) rotateY(-45deg);
  transform-style: preserve-3d;
  transition: all 150ms;
}

.right::before {
  position: absolute;
  content: "";
  width: 100%;
  height: 100%;
  background-color: rgb(206, 206, 206);
  transform-origin: center right;
  transform: rotateY(-90deg);
}

.right::after {
  position: absolute;
  content: "";
  width: 100%;
  height: 100%;
  background-color: rgb(112, 112, 112);
  transform-origin: center bottom;
  transform: rotateX(90deg);
}

.switch input:checked + .toggle > .left {
  transform: rotateX(10deg) rotateY(45deg);
  color: rgb(206, 206, 206);
}

.switch input:checked + .toggle > .right {
  transform: rotateX(10deg) rotateY(0deg);
  color: #487bdb;
}
/* -------------------------
   Uiverse Switch Style
------------------------- */
.switch {
  font-size: 17px;
  position: relative;
  display: inline-block;
  width: 5em;
  height: 2.5em;
  user-select: none;
}

.switch .cb {
  opacity: 0;
  width: 0;
  height: 0;
}

.toggle {
  position: absolute;
  cursor: pointer;
  width: 100%;
  height: 100%;
  background-color: #373737;
  border-radius: 0.1em;
  transition: 0.4s;
  text-transform: uppercase;
  font-weight: 700;
  overflow: hidden;
  box-shadow: -0.3em 0 0 0 #373737, -0.3em 0.3em 0 0 #373737,
    0.3em 0 0 0 #373737, 0.3em 0.3em 0 0 #373737, 0 0.3em 0 0 #373737;
}

.toggle > .left {
  position: absolute;
  display: flex;
  width: 50%;
  height: 88%;
  background-color: #f3f3f3;
  color: #373737;
  left: 0;
  bottom: 0;
  align-items: center;
  justify-content: center;
  transform-origin: right;
  transform: rotateX(10deg);
  transform-style: preserve-3d;
  transition: all 150ms;
}

.left::before {
  position: absolute;
  content: "";
  width: 100%;
  height: 100%;
  background-color: rgb(206, 206, 206);
  transform-origin: center left;
  transform: rotateY(90deg);
}

.left::after {
  position: absolute;
  content: "";
  width: 100%;
  height: 100%;
  background-color: rgb(112, 112, 112);
  transform-origin: center bottom;
  transform: rotateX(90deg);
}

.toggle > .right {
  position: absolute;
  display: flex;
  width: 50%;
  height: 88%;
  background-color: #f3f3f3;
  color: rgb(206, 206, 206);
  right: 1px;
  bottom: 0;
  align-items: center;
  justify-content: center;
  transform-origin: left;
  transform: rotateX(10deg) rotateY(-45deg);
  transform-style: preserve-3d;
  transition: all 150ms;
}

.right::before {
  position: absolute;
  content: "";
  width: 100%;
  height: 100%;
  background-color: rgb(206, 206, 206);
  transform-origin: center right;
  transform: rotateY(-90deg);
}

.right::after {
  position: absolute;
  content: "";
  width: 100%;
  height: 100%;
  background-color: rgb(112, 112, 112);
  transform-origin: center bottom;
  transform: rotateX(90deg);
}

.switch input:checked + .toggle > .left {
  transform: rotateX(10deg) rotateY(45deg);
  color: rgb(206, 206, 206);
}

.switch input:checked + .toggle > .right {
  transform: rotateX(10deg) rotateY(0deg);
  color: #487bdb;
}
    </style>
</head>

<body>

    <!-- üîµ ‡∏õ‡∏∏‡πà‡∏°‡∏™‡∏≤‡∏°‡∏Ç‡∏µ‡∏î -->
    <button id="menuBtn" class="absolute left-4 top-4 text-2xl cursor-pointer">&#9776;</button>

<!-- üîµ SIDEBAR -->
<div id="sidebar">

    <span id="closeSidebarX">&times;</span>

    <h2 class="text-lg font-bold mb-4 mt-6">Menu</h2>

    <ul class="space-y-3 margin-top-4">
        <li><a href="index.html" class="text-blue-600"> > ‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</a></li>
        <div class="sidebar-divider"></div>

        <li><a href="camera.html" class="text-blue-600"> > ‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡∏ï‡∏≤‡∏£‡∏≤‡∏á</a></li>
        <div class="sidebar-divider"></div>

        <li><a href="capture.html" class="text-blue-600"> > ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</a></li>
        <div class="sidebar-divider"></div>
    </ul>

    <!-- üîµ Switch Control -->
    <div style="margin-bottom: 25px;">

    <div id="lightStatus" 
        style="font-size:16px;color:#2563eb;margin-bottom:10px;margin-top:10px;">
        > ‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÑ‡∏ü : ‡πÑ‡∏ü‡∏õ‡∏¥‡∏î
    </div>

    <!-- üî• Uiverse Switch -->
    <label class="switch">
      <input id="lightSwitch" class="cb" type="checkbox" />
      <span class="toggle">
        <span class="left">off</span>
        <span class="right">on</span>
      </span>
    </label>

</div>



    <!-- ‚≠ê ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ + Logout ‡∏¢‡πâ‡∏≤‡∏¢‡∏°‡∏≤‡πÑ‡∏ß‡πâ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà ‚≠ê -->
    <div id="sidebarUserBox" style="
        position: absolute;
        bottom: 20px;
        left: 20px;
        right: 20px;
    ">
        <div id="sidebarUsername"
            class="font-bold text-blue-700 mb-2">
            ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ: -
        </div>

        <button id="sidebarLogoutBtn"
            class="w-full bg-red-500 hover:bg-red-600 text-white py-2 rounded-lg font-bold transition">
            ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
        </button>
    </div>

</div>

<div id="overlayBg"></div>


    <!-- TITLE -->
    <h1>‡∏†‡∏≤‡∏û‡∏à‡∏≤‡∏Å ESP32-CAM</h1>

    <!-- TOP RIGHT BUTTONS -->
    <div class="absolute right-0 top-0 flex space-x-2 mr-4 mt-2">
        <button id="userBtn" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-lg cursor-default">‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ:</button>
        <button id="logoutBtn" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
    </div>

    <!-- IMAGE GRID -->
    <div id="grid" class="grid"></div>
    <div id="empty" class="text-center text-gray-500 mt-10" style="display:none;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏†‡∏≤‡∏û‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</div>

    <!-- RELOAD BUTTON -->
    <button id="reloadBtn"
        class="fixed bottom-4 left-4 bg-blue-500 text-white px-5 py-3 rounded-full shadow-lg hover:bg-blue-600 transition">
        &#8635;‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏´‡∏°‡πà
    </button>

    <!-- POPUP PREVIEW -->
    <div id="previewOverlay">
        <span id="closePreview">&times;</span>
        <img id="previewImage" src="" />
    </div>

    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>

    <script>
        const SUPABASE_URL = "https://yiaemxmwfxrfrwtogamw.supabase.co";
        const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlpYWVteG13ZnhyZnJ3dG9nYW13Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE1MzMwOTYsImV4cCI6MjA3NzEwOTA5Nn0.I9MQPD_2LgpyELygjOroGG5qRTcwySM_t7c1o-ZvZpw";
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        const BUCKET_NAME = 'esp32-images';
        let currentUser = null;

        async function checkUser() {
            const { data: { session } } = await supabase.auth.getSession();
            if (!session || !session.user) { window.location.href = "login.html"; return; }
            currentUser = session.user;
            document.getElementById("userBtn").textContent = `‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ: ${currentUser.email}`;
            loadImages();
        }
        checkUser();

        document.getElementById("logoutBtn").addEventListener("click", async () => {
            const { error } = await supabase.auth.signOut();
            if (!error) window.location.href = "login.html";
        });

        async function loadImages() {
            const empty = document.getElementById("empty");
            const grid = document.getElementById("grid");

            if (!currentUser) return;

            const { data: images, error } = await supabase
                .from("user_images")
                .select("user_id, image_url, ip_address, created_at")
                .eq("user_id", currentUser.id)
                .order("created_at", { ascending: false });

            if (error) {
                console.error(error);
                grid.innerHTML = "";
                empty.style.display = "block";
                empty.textContent = "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏Ç‡∏ì‡∏∞‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•";
                return;
            }

            if (!images || images.length === 0) {
                grid.innerHTML = "";
                empty.style.display = "block";
                empty.textContent = "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏†‡∏≤‡∏û‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö";
                return;
            }

            empty.style.display = "none";
            grid.innerHTML = "";

            images.forEach(item => {
                const card = document.createElement("div");
                card.className = "card";

                const img = document.createElement("img");
                img.className = "thumb";

                let imageUrl = "";
                if (item.image_url) {
                    if (typeof item.image_url === "object" && item.image_url.path) {
                        const { data: urlData } = supabase
                            .storage
                            .from(BUCKET_NAME)
                            .getPublicUrl(item.image_url.path);
                        imageUrl = urlData.publicUrl;
                    } else if (typeof item.image_url === "string") {
                        imageUrl = item.image_url;
                    }
                }
                img.src = imageUrl;

                card.addEventListener("click", () => {
                    document.getElementById("previewImage").src = imageUrl;
                    document.getElementById("previewOverlay").style.display = "flex";
                });

                const meta = document.createElement("div");
                meta.className = "meta";

                const title = document.createElement("div");
                title.className = "title";
                title.textContent = "Captured by ESP32-CAM";

                const stats = document.createElement("div");
                stats.className = "stats";
                stats.textContent = `IP: ${item.ip_address || "‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö"} ‚Ä¢ ${new Date(item.created_at).toLocaleString()}`;

                meta.appendChild(title);
                meta.appendChild(stats);
                card.appendChild(img);
                card.appendChild(meta);

                grid.appendChild(card);
            });
        }

        document.getElementById("reloadBtn").addEventListener("click", loadImages);

        document.getElementById("closePreview").addEventListener("click", () => {
            document.getElementById("previewOverlay").style.display = "none";
        });

        document.getElementById("previewOverlay").addEventListener("click", e => {
            if (e.target.id === "previewOverlay") {
                document.getElementById("previewOverlay").style.display = "none";
            }
        });

    const sidebar = document.getElementById("sidebar");
    const overlay = document.getElementById("overlayBg");
    const menuBtn = document.getElementById("menuBtn");
    const closeBtn = document.getElementById("closeSidebarX");

    // ‡πÄ‡∏õ‡∏¥‡∏î sidebar
    menuBtn.addEventListener("click", () => {
        sidebar.classList.add("active");
        overlay.style.display = "block";
    });

    // ‡∏õ‡∏¥‡∏î sidebar ‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏≤‡∏Å‡∏ö‡∏≤‡∏ó
    closeBtn.addEventListener("click", () => {
        sidebar.classList.remove("active");
        overlay.style.display = "none";
    });

    // ‡∏õ‡∏¥‡∏î sidebar ‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏•‡∏¥‡∏Å‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á
    overlay.addEventListener("click", () => {
        sidebar.classList.remove("active");
        overlay.style.display = "none";
    });

    lightSwitch.addEventListener("change",(e)=>{
    lightStatus.textContent = e.target.checked ? "> ‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÑ‡∏ü : ‡πÑ‡∏ü‡πÄ‡∏õ‡∏¥‡∏î" : "> ‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÑ‡∏ü : ‡πÑ‡∏ü‡∏õ‡∏¥‡∏î";
});

    </script>
</body>
</html>

