<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Robot Arm Control</title>
<!-- Tailwind CSS -->
<script src="https://cdn.tailwindcss.com"></script>
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- Google Fonts (Prompt for Thai) -->
<link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600&display=swap" rel="stylesheet">

<style>
  body {
    font-family: 'Prompt', sans-serif;
    background-color: #f1f5f9; /* Slate-100 */
    color: #334155; /* Slate-700 */
    overflow-x: hidden;
  }

  /* --- Responsive Iframe --- */
  .camera-container {
    position: relative;
    width: 100%;
    max-width: 640px;
    aspect-ratio: 4/3;
    background: #000;
    border-radius: 16px;
    overflow: hidden;
    box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    margin: 0 auto;
  }
  .camera-container iframe {
    width: 100%;
    height: 100%;
    border: none;
  }

  /* --- Grid Styling --- */
  .grid-wrapper {
    overflow: hidden; /* ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÅ‡∏ô‡∏ß‡∏ô‡∏≠‡∏ô‡πÑ‡∏î‡πâ‡πÉ‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ */
    padding: 10px;
    border-radius: 16px;
    background: white;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    display: flex;
    justify-content: center;
  }
  
  .grid-container {
    position: relative;
    background: white;
    /* border: 1px solid #e2e8f0; ‡πÄ‡∏≠‡∏≤ border ‡∏≠‡∏≠‡∏Å‡πÉ‡∏´‡πâ‡∏î‡∏π‡∏Ñ‡∏•‡∏µ‡∏ô */
    margin-top: 0;
    flex-shrink: 0; /* ‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏´‡∏î‡πÉ‡∏ô flex */
  }

  .vertical-line, .horizontal-line {
    position: absolute;
    background: #e2e8f0; /* ‡πÄ‡∏™‡πâ‡∏ô‡∏™‡∏µ‡∏à‡∏≤‡∏á‡∏•‡∏á Slate-200 */
  }
  .vertical-line { width: 1px; top: 0; bottom: 0; }
  .horizontal-line { height: 1px; left: 0; right: 0; }

  /* Seed / Point */
  .point-container { position: absolute; }
  .seed {
    font-size: 28px;
    cursor: pointer;
    user-select: none;
    transform: translate(-50%, -50%);
    transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
    filter: drop-shadow(0 2px 2px rgba(0,0,0,0.1));
  }
  .seed:hover {
    transform: translate(-50%, -50%) scale(1.4);
  }

  /* --- Sidebar --- */
  #sidebar {
    position: fixed;
    top: 0;
    left: -280px;
    width: 280px;
    height: 100%;
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(10px);
    box-shadow: 4px 0 24px rgba(0,0,0,0.05);
    z-index: 60;
    transition: left 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    padding: 24px;
    display: flex;
    flex-direction: column;
  }
  #sidebar.active { left: 0; }
  
  .sidebar-link {
    display: flex;
    align-items: center;
    padding: 12px 16px;
    margin-bottom: 8px;
    border-radius: 12px;
    color: #475569;
    font-weight: 500;
    transition: all 0.2s;
  }
  .sidebar-link:hover {
    background: #eff6ff;
    color: #2563eb;
    transform: translateX(4px);
  }

  /* --- Overlay (Card / Bottom Sheet) --- */
  .grid-overlay {
    position: fixed;
    background: rgba(255, 255, 255, 0.98);
    backdrop-filter: blur(12px);
    z-index: 1000;
    padding: 24px;
    box-shadow: 0 10px 40px rgba(0,0,0,0.2);
    display: none;
    flex-direction: column;
    /* Desktop Default */
    top: 20px;
    right: 20px;
    width: 360px;
    max-height: calc(100vh - 40px);
    border-radius: 20px;
    overflow-y: auto;
    animation: slideInRight 0.3s ease-out;
  }

  /* Mobile Overlay -> Bottom Sheet */
  @media (max-width: 768px) {
    .grid-overlay {
      top: auto;
      bottom: 0;
      right: 0;
      left: 0;
      width: 100%;
      max-height: 85vh;
      border-radius: 24px 24px 0 0;
      animation: slideUp 0.3s ease-out;
    }
  }

  @keyframes slideInRight {
    from { opacity: 0; transform: translateX(20px); }
    to { opacity: 1; transform: translateX(0); }
  }
  @keyframes slideUp {
    from { opacity: 0; transform: translateY(100%); }
    to { opacity: 1; transform: translateY(0); }
  }

  /* --- Custom Scrollbar --- */
  ::-webkit-scrollbar { width: 6px; height: 6px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
  ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

  /* --- Buttons & Switches --- */
  .mode-btn {
    padding: 10px 20px;
    border-radius: 12px;
    font-weight: 600;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.2s;
    border: 1px solid transparent;
    width: 100%;
  }
  .mode-btn.active {
    background: #2563eb;
    color: white;
    box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
  }
  .mode-btn.inactive {
    background: white;
    color: #64748b;
    border-color: #e2e8f0;
  }
  .mode-btn.inactive:hover {
    background: #f8fafc;
    border-color: #cbd5e1;
  }

  /* Toggle Switch */
  .switch {
    position: relative;
    display: inline-block;
    width: 50px;
    height: 28px;
  }
  .switch input { opacity: 0; width: 0; height: 0; }
  .slider {
    position: absolute;
    cursor: pointer;
    top: 0; left: 0; right: 0; bottom: 0;
    background-color: #e2e8f0;
    transition: .3s cubic-bezier(0.4, 0, 0.2, 1);
    border-radius: 34px;
  }
  .slider:before {
    position: absolute;
    content: "";
    height: 22px;
    width: 22px;
    left: 3px;
    bottom: 3px;
    background-color: white;
    transition: .3s cubic-bezier(0.4, 0, 0.2, 1);
    border-radius: 50%;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }
  input:checked + .slider { background-color: #10b981; }
  input:checked + .slider:before { transform: translateX(22px); }

  /* Action Buttons */
  .action-btn {
    width: 100%;
    padding: 12px;
    border-radius: 12px;
    font-weight: 600;
    color: white;
    transition: transform 0.1s, box-shadow 0.2s;
    margin-bottom: 8px;
    font-size: 14px;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
  }
  .action-btn:active { transform: scale(0.98); }
  .btn-green { background: linear-gradient(135deg, #10b981, #059669); }
  .btn-blue { background: linear-gradient(135deg, #3b82f6, #2563eb); }
  .btn-purple { background: linear-gradient(135deg, #a855f7, #9333ea); }
  .btn-red { background: linear-gradient(135deg, #ef4444, #dc2626); }
  .btn-gray { background: #64748b; }
  .btn-gray:hover { background: #475569; }

  /* Upload Button Style */
  .upload-area {
    display: block;       /* ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ: ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏•‡πà‡∏≠‡∏á */
    width: 100%;          /* ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ: ‡πÉ‡∏´‡πâ‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡πÄ‡∏ï‡πá‡∏°‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà */
    border: 2px dashed #cbd5e1;
    border-radius: 12px;
    padding: 15px;
    text-align: center;
    cursor: pointer;
    transition: all 0.2s;
    color: #64748b;
    margin-bottom: 10px;
    font-size: 14px;
  }
  .upload-area:hover {
    border-color: #2563eb;
    background: #eff6ff;
    color: #2563eb;
  }

  /* Hamburger */
  .hamburger-btn {
    position: fixed;
    top: 20px;
    left: 20px;
    z-index: 50;
    background: white;
    border-radius: 50%;
    width: 48px;
    height: 48px;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    cursor: pointer;
    transition: transform 0.2s;
  }
  .hamburger-btn:hover { transform: scale(1.05); }

  /* Overlay Background */
  #overlayBg {
    position: fixed;
    top:0; left:0; width:100%; height:100%;
    background: rgba(0,0,0,0.3);
    backdrop-filter: blur(2px);
    display:none;
    z-index:55;
  }
  
  /* Tooltip */
  .point-tooltip {
    background: #1e293b;
    color: white;
    padding: 6px 10px;
    border-radius: 8px;
    font-size: 12px;
    white-space: nowrap;
    opacity: 0;
    transition: opacity 0.2s;
    z-index: 20;
    pointer-events: none;
    position: absolute;
    bottom: 120%;
    left: 50%;
    transform: translateX(-50%);
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
  }
  .point-container:hover .point-tooltip { opacity: 1; }

</style>
</head>
<body class="bg-slate-50">

  <!-- üîµ ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏°‡∏ô‡∏π (Hamburger) -->
  <div id="menuBtn" class="hamburger-btn">
    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#1e293b" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </div>

  <!-- üîµ SIDEBAR -->
  <div id="sidebar">
    <div class="flex justify-between items-center mb-8">
      <h2 class="text-2xl font-bold text-slate-800">Menu</h2>
      <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏õ‡∏¥‡∏î Sidebar -->
      <label class="cursor-pointer" id="closeSidebarBtn">
        <input type="checkbox" id="sidebarToggle" class="hidden">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#64748b" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </label>
    </div>

    <nav class="flex-1 space-y-1">
      <a href="index.html" class="sidebar-link home">üè† ‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</a>
      <a href="camera.html" class="sidebar-link camera bg-blue-50 text-blue-600">ü§ñ ‡πÅ‡∏Ç‡∏ô‡∏Å‡∏• 1</a>
      <a href="camera2.html" class="sidebar-link camera2">ü§ñ ‡πÅ‡∏Ç‡∏ô‡∏Å‡∏• 2</a>
      <a href="auto.html" class="sidebar-link auto">‚ö° ‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</a>
      <a href="capture.html" class="sidebar-link image">üì∑ ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</a>
      <a href="FAQ.html" class="sidebar-link faq">‚ùì ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡πÜ</a>
    </nav>

    <!-- User Info -->
    <div class="mt-auto pt-6 border-t border-slate-200">
      <div id="sidebarUsername" class="text-sm font-semibold text-slate-600 mb-3 truncate">
        ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ: -
      </div>
      <button id="sidebarLogoutBtn" class="w-full bg-red-50 hover:bg-red-100 text-red-600 py-2.5 rounded-xl font-semibold transition text-sm">
        ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
      </button>
    </div>
  </div>

  <div id="overlayBg"></div>

  <!-- üîµ MAIN CONTENT -->
  <div id="app" class="w-full max-w-5xl mx-auto px-4 py-8 md:py-12 pb-20">
    
    <header class="text-center mb-8 mt-8 md:mt-0">
      <h1 class="text-3xl md:text-4xl font-bold text-slate-800 mb-2">‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡πÅ‡∏Ç‡∏ô‡∏Å‡∏• 1</h1>
      <p class="text-slate-500 text-sm md:text-base">‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏π‡πÅ‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏≤‡∏∞‡∏ï‡πâ‡∏ô‡∏Å‡∏•‡πâ‡∏≤‡∏Å‡∏£‡∏∞‡∏ñ‡∏≤‡∏á‡πÅ‡∏ö‡∏ö‡∏Ñ‡∏£‡∏ö‡∏ß‡∏á‡∏à‡∏£</p>
    </header>

    <div class="grid grid-cols-1 lg:grid-cols-12 gap-8 items-start">
      
      <!-- Left Column: Camera & Controls -->
      <div class="lg:col-span-6 flex flex-col gap-6">
        <!-- Camera Frame -->
        <div class="camera-container">
          <iframe src="http://10.109.37.89" allow="camera; microphone;"></iframe>
        </div>

        <!-- Mode Select -->
        <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 flex gap-3">
            <button id="detailModeBtn" class="mode-btn active" onclick="setOverlayMode('detail')">
              üîç ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
            </button>
            <button id="handModeBtn" class="mode-btn inactive" onclick="setOverlayMode('hand')">
              üéÆ ‡∏™‡∏±‡πà‡∏á‡∏á‡∏≤‡∏ô‡πÅ‡∏Ç‡∏ô‡∏Å‡∏•
            </button>
        </div>

        <!-- System Status Cards -->
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
          <!-- Light Control -->
          <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 flex items-center justify-between">
            <div class="flex items-center gap-3">
              <div class="p-2 bg-yellow-100 text-yellow-600 rounded-lg">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4M4.93 19.07l2.83-2.83M16.24 7.76l2.83-2.83"/></svg>
              </div>
              <div>
                <p class="text-xs text-slate-400 font-bold uppercase">‡πÑ‡∏ü‡∏™‡πà‡∏≠‡∏á‡∏™‡∏ß‡πà‡∏≤‡∏á</p>
                <p class="font-bold text-slate-700" id="status">---</p>
              </div>
            </div>
            <label class="switch">
              <input type="checkbox" id="lightSwitch">
              <span class="slider"></span>
            </label>
          </div>

          <!-- Solar Control -->
          <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 flex items-center justify-between">
            <div class="flex items-center gap-3">
              <div class="p-2 bg-orange-100 text-orange-600 rounded-lg">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="5"/><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/></svg>
              </div>
              <div>
                <p class="text-xs text-slate-400 font-bold uppercase">‡πÇ‡∏ã‡∏•‡∏≤‡∏£‡πå‡πÄ‡∏ã‡∏•‡∏•‡πå</p>
                <p class="font-bold text-slate-700" id="solarStatus">---</p>
              </div>
            </div>
            <label class="switch">
              <input type="checkbox" id="solarSwitch">
              <span class="slider"></span>
            </label>
          </div>
        </div>

        <!-- Global Actions (Hidden by default) -->
        <div id="allActionArea" class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 hidden flex-col gap-3">
          <p class="text-center text-sm text-slate-500 font-semibold mb-1">‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡πÅ‡∏õ‡∏•‡∏á</p>
          <div class="grid grid-cols-2 gap-3">
            <button class="action-btn btn-purple" id="allMoistureBtn">üíß ‡∏ß‡∏±‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
            <button class="action-btn btn-blue" id="allWaterBtn">üöø ‡∏£‡∏î‡∏ô‡πâ‡∏≥‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
          </div>
          <button class="action-btn btn-red mt-1" id="allResetBtn">üîÑ ‡∏£‡∏µ‡πÄ‡∏ã‡∏ï‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÅ‡∏Ç‡∏ô‡∏Å‡∏•</button>
        </div>

      </div>

      <!-- Right Column: Grid Map -->
      <div class="lg:col-span-6">
        <!-- ‚úÖ ‡πÅ‡∏Å‡πâ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ: ‡πÄ‡∏û‡∏¥‡πà‡∏° w-fit mx-auto max-w-full -->
        <div class="bg-white p-4 md:p-6 rounded-3xl shadow-lg border border-slate-100 w-full mx-auto">
           <div class="flex items-center justify-between mb-4">
             <h3 class="font-bold text-lg text-slate-700">‡πÅ‡∏ú‡∏ô‡∏ú‡∏±‡∏á‡πÅ‡∏õ‡∏•‡∏á‡∏õ‡∏•‡∏π‡∏Å</h3>
             <span class="text-xs text-slate-400 bg-slate-100 px-2 py-1 rounded-md">6 x 11 Grid</span>
           </div>
           
           <div class="grid-wrapper">
             <div class="grid-container" id="grid">
               <!-- JS ‡∏à‡∏∞‡∏ß‡∏≤‡∏î Grid ‡πÉ‡∏™‡πà‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ -->
             </div>
           </div>
           <p class="text-center text-xs text-slate-400 mt-4">‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏ô‡∏Å‡∏•‡πâ‡∏≤ üå± ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏´‡∏£‡∏∑‡∏≠‡∏™‡∏±‡πà‡∏á‡∏á‡∏≤‡∏ô</p>
        </div>
      </div>

    </div>
  </div>

  <!-- üîµ OVERLAY POPUP (Desktop & Mobile) -->
  <div class="grid-overlay" id="gridOverlay">
    
    <!-- Header -->
    <div class="flex items-center justify-between mb-4 pb-4 border-b border-slate-100">
      <button class="text-slate-400 hover:text-blue-600 transition" onclick="closeGridOverlay()">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 12H5"/><path d="M12 19l-7-7 7-7"/></svg>
      </button>
      <h3 class="text-lg font-bold text-slate-800" id="pointTitle">‡∏à‡∏∏‡∏î (1,1)</h3>
      <div class="w-6"></div> <!-- Spacer for center alignment -->
    </div>

    <!-- Content -->
    <div id="pointOverlayContent" class="flex-1 overflow-y-auto pr-1">
      
      <div class="mb-4">
        <label class="block text-xs font-bold text-slate-500 mb-1 uppercase">‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏∏‡∏î</label>
        <div class="flex gap-2">
          <input type="text" id="pointNameInput" placeholder="‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏∏‡∏î..." 
            class="flex-1 bg-slate-50 border border-slate-200 rounded-xl px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 transition">
          <button class="bg-slate-700 text-white px-3 py-2 rounded-xl text-sm font-bold hover:bg-slate-800 transition" onclick="renameSuccess()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
        </div>
      </div>

      <!-- Upload -->
      <label class="upload-area group">
        <div class="flex flex-col items-center gap-2">
          <svg class="text-slate-400 group-hover:text-blue-500 transition" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
          <span class="text-sm">‡πÅ‡∏ï‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</span>
        </div>
        <input type="file" id="pointFileInput" accept="image/*" hidden>
      </label>
      
      <img id="pointImage" class="w-full h-40 object-cover rounded-xl mb-4 hidden border border-slate-200">

      <!-- Chart -->
      <div id="chartContainer">
        <p id="chartTitle" class="text-center text-xs text-slate-500 font-bold mb-2">‡∏Å‡∏£‡∏≤‡∏ü‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á (%)</p>
        <canvas id="pointChart" class="w-full bg-white rounded-xl" style="max-height: 200px;"></canvas>
      </div>

      <!-- Action Buttons (Inline Hand Mode) -->
      <div id="inlineHandArea" class="hidden flex flex-col gap-2 mt-2">
        <!-- JS ‡∏à‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏õ‡∏∏‡πà‡∏°‡πÉ‡∏™‡πà‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ -->
      </div>

    </div>
  </div>

  <footer class="text-center py-6 text-slate-400 text-xs">
    &copy; 2025 Klabot Dev Team. All rights reserved.
  </footer>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>

  <!-- IMPORTANT: Logic Script kept EXACTLY as original to preserve functionality -->
  <script>
    /* =========================================
       KEEPING ORIGINAL LOGIC INTACT
       ========================================= */
    const SUPABASE_URL = "https://yiaemxmwfxrfrwtogamw.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlpYWVteG13ZnhyZnJ3dG9nYW13Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE1MzMwOTYsImV4cCI6MjA3NzEwOTA5Nn0.I9MQPD_2LgpyELygjOroGG5qRTcwySM_t7c1o-ZvZpw";
    const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    let currentUser = null;
    let currentPoint = {x:0,y:0};
    let chart = null;

    // ‡πÄ‡∏ä‡πá‡∏Ñ user
    async function checkUser(){
      const { data: { session } } = await supabaseClient.auth.getSession();
      if(!session || !session.user){ window.location.href="login.html"; return; }
      currentUser = session.user;
      document.getElementById("sidebarUsername").textContent = `‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ: ${currentUser.email}`;
      document.getElementById("app").style.display="block";
      initGrid();
    }
    checkUser();

    // logout
    document.getElementById("sidebarLogoutBtn").addEventListener("click", async ()=>{
      const {error} = await supabaseClient.auth.signOut();
      if(error) console.error(error.message); else window.location.href="login.html";
    });

    function initGrid(){
      const grid = document.getElementById("grid");
      grid.innerHTML = "";

      const cols = 6;
      const rows = 11;

      // üî¥ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ç‡∏ô‡∏≤‡∏î‡∏ä‡πà‡∏≠‡∏á (cellSize) ‡πÉ‡∏´‡πâ‡∏¢‡∏∑‡∏î‡∏´‡∏¢‡∏∏‡πà‡∏ô‡∏ï‡∏≤‡∏°‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
      let cellSize = 60; // ‡∏Ñ‡πà‡∏≤‡∏õ‡∏Å‡∏ï‡∏¥‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Desktop

      // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠ (‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ < 768px)
      /* ‚úÖ ‡πÅ‡∏Å‡πâ‡πÄ‡∏õ‡πá‡∏ô (‡πÉ‡∏ä‡πâ window.innerWidth - 60 ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏ö‡∏ã‡πâ‡∏≤‡∏¢‡∏Ç‡∏ß‡∏≤‡πÉ‡∏´‡πâ‡∏û‡∏≠‡∏î‡∏µ‡∏™‡∏ß‡∏¢‡∏á‡∏≤‡∏°) */
      if (window.innerWidth < 768) {
        // ‡πÉ‡∏ä‡πâ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á ‡∏•‡∏ö padding ‡∏ã‡πâ‡∏≤‡∏¢‡∏Ç‡∏ß‡∏≤‡∏Ç‡∏≠‡∏á Container (‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì 48-60px)
        const availableWidth = window.innerWidth - 60; 
        cellSize = Math.floor(availableWidth / (cols + 1));
      }
      
      // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡πÄ‡∏•‡πá‡∏Å‡∏à‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ (‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥ 40px ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏à‡∏¥‡πâ‡∏°‡∏á‡πà‡∏≤‡∏¢)
      if (cellSize < 40) cellSize = 40; 

      grid.style.width  = `${cellSize * (cols + 1)}px`;
      grid.style.height = `${cellSize * (rows + 1)}px`;

      /* ‡πÄ‡∏™‡πâ‡∏ô‡∏ï‡∏±‡πâ‡∏á */
      for(let i = 1; i <= cols; i++){
        const v = document.createElement("div");
        v.className = "vertical-line";
        v.style.left = `${i * cellSize}px`;
        grid.appendChild(v);
      }

      /* ‡πÄ‡∏™‡πâ‡∏ô‡∏ô‡∏≠‡∏ô */
      for(let j = 1; j <= rows; j++){
        const h = document.createElement("div");
        h.className = "horizontal-line";
        h.style.top = `${j * cellSize}px`;
        grid.appendChild(h);
      }

      /* ‡∏à‡∏∏‡∏î üå± */
      for(let x = 1; x <= cols; x++){
        for(let y = 1; y <= rows; y++){
          const px = x * cellSize;
          const py = y * cellSize;

          const pointContainer = document.createElement("div");
          pointContainer.className = "point-container";
          pointContainer.style.left = `${px}px`;
          pointContainer.style.top = `${py}px`;

          const seed = document.createElement("div");
          seed.className = "seed";
          seed.textContent = "üå±";
          
          // üî¥ ‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡∏ï‡πâ‡∏ô‡πÑ‡∏°‡πâ‡∏ï‡∏≤‡∏°‡∏Ç‡∏ô‡∏≤‡∏î‡∏ä‡πà‡∏≠‡∏á
          seed.style.fontSize = `${cellSize * 0.5}px`; 

          // tooltip
          const tooltip = document.createElement("div");
          tooltip.className = "point-tooltip";
          tooltip.textContent = `(${x}, ${y})`;

          // ‡πÇ‡∏´‡∏•‡∏î‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏∏‡∏î‡∏à‡∏≤‡∏Å Supabase ‡∏ï‡∏≠‡∏ô hover
          pointContainer.addEventListener("mouseenter", async () => {
            const { data } = await supabaseClient
              .from("points")
              .select("name")
              .eq("user_id", currentUser.id)
              .eq("x", x)
              .eq("y", y)
              .single();

            tooltip.innerHTML = `
              ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á: (${x},${y})<br>
              ‡∏ä‡∏∑‡πà‡∏≠: ${data?.name || "-"}
            `;
          });

          // ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà‡∏Å‡∏î‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ
          if(x >= 4 && y >= 1){
            seed.style.opacity = "0.3";
            seed.style.cursor = "not-allowed";
          } else {
            seed.addEventListener("click", () => openGridOverlay(x, y));
          }

          pointContainer.appendChild(seed);
          pointContainer.appendChild(tooltip);
          grid.appendChild(pointContainer);
        }
      }
    }

    // ‡πÄ‡∏û‡∏¥‡πà‡∏° Event Listener ‡πÉ‡∏´‡πâ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏´‡∏°‡∏∏‡∏ô‡∏à‡∏≠
    window.addEventListener('resize', initGrid);

    // Overlay functions
    async function openGridOverlay(x, y) {
      currentPoint = { x, y };

      const overlay = document.getElementById("gridOverlay");
      overlay.style.display = "flex"; // Changed to flex for centering logic

      document.getElementById("pointTitle").textContent = `‡∏à‡∏∏‡∏î (${x},${y})`;

      // ‚≠ê ‡∏´‡∏ô‡πà‡∏ß‡∏á 1 tick ‡∏Å‡∏±‡∏ô‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô‡∏õ‡∏¥‡∏î overlay
      setTimeout(() => {
        document.addEventListener("click", outsideOverlayClick);
      }, 0);

      setOverlayMode(overlayMode);

      // ‡πÇ‡∏´‡∏•‡∏î‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞‡∏£‡∏π‡∏õ
      const { data, error } = await supabaseClient.from("points").select("*").eq("user_id", currentUser.id).eq("x", x).eq("y", y).single();
      const input = document.getElementById("pointNameInput");
      input.value = data?.name || "";
      const img = document.getElementById("pointImage");
      if (data?.image_url) { img.src = data.image_url; img.style.display = "block"; } else img.style.display = "none";

      // ‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô‡∏à‡∏≤‡∏Å paintable
      const { data: vals } = await supabaseClient
        .from("paintable")
        .select("soil_moisture, inserted_at")
        .eq("user_id", currentUser.id)
        .eq("point_x", x)
        .eq("point_y", y)
        .order("inserted_at", { ascending: true });

      const labels = vals?.map(d => {
        const date = new Date(d.inserted_at);
        return [
          date.toLocaleDateString("th-TH"),
          date.toLocaleTimeString("th-TH")
        ];
      }) || [];

      const values = vals?.map(d => d.soil_moisture) || [];

      // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î chart overlay pointChart
      const ctx = document.getElementById("pointChart").getContext("2d");
      const chartTitle = document.getElementById("chartTitle");
      
      // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏£‡∏≤‡∏ü‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÇ‡∏´‡∏°‡∏î‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
      if (overlayMode === "detail") {
        chartTitle.style.display = "block";

        const canvas = document.getElementById("pointChart");
        canvas.style.display = "block";

        if (chart) chart.destroy();

        chart = new Chart(ctx, {
          type: 'line',
          data: {
            labels,
            datasets: [{
              label: '‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô',
              data: values,
              borderColor: '#3b82f6', // Tailwind Blue-500
              backgroundColor: 'rgba(59, 130, 246, 0.1)',
              tension: 0.4,
              fill: true,
              pointRadius: 3,
              pointBackgroundColor: '#fff',
              pointBorderColor: '#3b82f6'
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
              x: { display: true, grid: {display: false} },
              y: { display: true, min: 0, max: 100, border: {dash: [4,4]} }
            }
          }
        });

      } else {
        chartTitle.style.display = "none";
        if (chart) {
          chart.destroy();
          chart = null;
        }
        document.getElementById("pointChart").style.display = "none";
      }
    }

    /* ===============================
       MAP ‡∏à‡∏∏‡∏î ‚Üí ACTION ‡πÅ‡∏Ç‡∏ô‡∏Å‡∏•
    ================================ */
    const pointActionMap = {
      "1,1": "A", "1,2": "B", "1,3": "C", "1,4": "D", "1,5": "E", "1,6": "F", "1,7": "G", "1,8": "H", "1,9": "I", "1,10": "J", "1,11": "K",
      "2,1": "L", "2,2": "M", "2,3": "N", "2,4": "O", "2,5": "P", "2,6": "Q", "2,7": "R", "2,8": "S", "2,9": "T", "2,10": "U", "2,11": "V",
      "3,1": "W", "3,2": "X", "3,3": "Y", "3,4": "Z", "3,5": "A1", "3,6": "B1", "3,7": "C1", "3,8": "D1", "3,9": "E1", "3,10": "F1", "3,11": "G1",
      "4,1": "A2", "4,2": "B2", "4,3": "C2", "4,4": "D2", "4,5": "E2", "4,6": "F2", "4,7": "G2", "4,8": "H2", "4,9": "I2", "4,10": "J2", "4,11": "K2",
      "5,1": "L2", "5,2": "M2", "5,3": "N2", "5,4": "O2", "5,5": "P2", "5,6": "Q2", "5,7": "R2", "5,8": "S2", "5,9": "T2", "5,10": "U2", "5,11": "V2",
      "6,1": "W2", "6,2": "X2", "6,3": "Y2", "6,4": "Z2", "6,5": "A3", "6,6": "B3", "6,7": "C3", "6,8": "D3", "6,9": "E3", "6,10": "F3", "6,11": "G3"
    };

    const pointWaterMap = {
      "1,1": "water_A_1_1", "1,2": "water_A_1_2", "1,3": "water_A_1_3", "1,4": "water_A_1_4", "1,5": "water_A_1_5", "1,6": "water_A_1_6", "1,7": "water_A_1_7", "1,8": "water_A_1_8", "1,9": "water_A_1_9", "1,10": "water_A_1_10", "1,11": "water_A_1_11",
      "2,1": "water_A_2_1", "2,2": "water_A_2_2", "2,3": "water_A_2_3", "2,4": "water_A_2_4", "2,5": "water_A_2_5", "2,6": "water_A_2_6", "2,7": "water_A_2_7", "2,8": "water_A_2_8", "2,9": "water_A_2_9", "2,10": "water_A_2_10", "2,11": "water_A_2_11",
      "3,1": "water_A_3_1", "3,2": "water_A_3_2", "3,3": "water_A_3_3", "3,4": "water_A_3_4", "3,5": "water_A_3_5", "3,6": "water_A_3_6", "3,7": "water_A_3_7", "3,8": "water_A_3_8", "3,9": "water_A_3_9", "3,10": "water_A_3_10", "3,11": "water_A_3_11",
      "4,1": "water_A_4_1", "4,2": "water_A_4_2", "4,3": "water_A_4_3", "4,4": "water_A_4_4", "4,5": "water_A_4_5", "4,6": "water_A_4_6", "4,7": "water_A_4_7", "4,8": "water_A_4_8", "4,9": "water_A_4_9", "4,10": "water_A_4_10", "4,11": "water_A_4_11",
      "5,1": "water_A_5_1", "5,2": "water_A_5_2", "5,3": "water_A_5_3", "5,4": "water_A_5_4", "5,5": "water_A_5_5", "5,6": "water_A_5_6", "5,7": "water_A_5_7", "5,8": "water_A_5_8", "5,9": "water_A_5_9", "5,10": "water_A_5_10", "5,11": "water_A_5_11",
      "6,1": "water_A_6_1", "6,2": "water_A_6_2", "6,3": "water_A_6_3", "6,4": "water_A_6_4", "6,5": "water_A_6_5", "6,6": "water_A_6_6", "6,7": "water_A_6_7", "6,8": "water_A_6_8", "6,9": "water_A_6_9", "6,10": "water_A_6_10", "6,11": "water_A_6_11"
    };

    const pointMoistureMap = {
      "1,1": "moisture_A_1_1", "1,2": "moisture_A_1_2", "1,3": "moisture_A_1_3", "1,4": "moisture_A_1_4", "1,5": "moisture_A_1_5", "1,6": "moisture_A_1_6", "1,7": "moisture_A_1_7", "1,8": "moisture_A_1_8", "1,9": "moisture_A_1_9", "1,10": "moisture_A_1_10", "1,11": "moisture_A_1_11",
      "2,1": "moisture_A_2_1", "2,2": "moisture_A_2_2", "2,3": "moisture_A_2_3", "2,4": "moisture_A_2_4", "2,5": "moisture_A_2_5", "2,6": "moisture_A_2_6", "2,7": "moisture_A_2_7", "2,8": "moisture_A_2_8", "2,9": "moisture_A_2_9", "2,10": "moisture_A_2_10", "2,11": "moisture_A_2_11",
      "3,1": "moisture_A_3_1", "3,2": "moisture_A_3_2", "3,3": "moisture_A_3_3", "3,4": "moisture_A_3_4", "3,5": "moisture_A_3_5", "3,6": "moisture_A_3_6", "3,7": "moisture_A_3_7", "3,8": "moisture_A_3_8", "3,9": "moisture_A_3_9", "3,10": "moisture_A_3_10", "3,11": "moisture_A_3_11",
      "4,1": "moisture_A_4_1", "4,2": "moisture_A_4_2", "4,3": "moisture_A_4_3", "4,4": "moisture_A_4_4", "4,5": "moisture_A_4_5", "4,6": "moisture_A_4_6", "4,7": "moisture_A_4_7", "4,8": "moisture_A_4_8", "4,9": "moisture_A_4_9", "4,10": "moisture_A_4_10", "4,11": "moisture_A_4_11",
      "5,1": "moisture_A_5_1", "5,2": "moisture_A_5_2", "5,3": "moisture_A_5_3", "5,4": "moisture_A_5_4", "5,5": "moisture_A_5_5", "5,6": "moisture_A_5_6", "5,7": "moisture_A_5_7", "5,8": "moisture_A_5_8", "5,9": "moisture_A_5_9", "5,10": "moisture_A_5_10", "5,11": "moisture_A_5_11",
      "6,1": "moisture_A_6_1", "6,2": "moisture_A_6_2", "6,3": "moisture_A_6_3", "6,4": "moisture_A_6_4", "6,5": "moisture_A_6_5", "6,6": "moisture_A_6_6", "6,7": "moisture_A_6_7", "6,8": "moisture_A_6_8", "6,9": "moisture_A_6_9", "6,10": "moisture_A_6_10", "6,11": "moisture_A_6_11"
    };

    function renderInlineHandButtons(){
      const area = document.getElementById("inlineHandArea");
      area.innerHTML = "";

      const key = `${currentPoint.x},${currentPoint.y}`;
      const action = pointActionMap[key];
      const waterAction = pointWaterMap[key];
      const moistureAction = pointMoistureMap[key];

      if(action){
        const btn = document.createElement("button");
        btn.className = "action-btn btn-gray";
        btn.innerHTML = `<span>ü§è</span> ‡∏Ñ‡∏µ‡∏ö‡∏ï‡πâ‡∏ô‡∏Å‡∏•‡πâ‡∏≤`;
        btn.onclick = (e) => sendAction(action, e);
        area.appendChild(btn);
      }

      if(waterAction){
        const btn = document.createElement("button");
        btn.className = "action-btn btn-blue";
        btn.innerHTML = `<span>üöø</span> ‡∏£‡∏î‡∏ô‡πâ‡∏≥‡∏ï‡πâ‡∏ô‡∏Å‡∏•‡πâ‡∏≤`;
        btn.onclick = (e) => sendAction(waterAction, e);
        area.appendChild(btn);
      }

      if(moistureAction){
        const btn = document.createElement("button");
        btn.className = "action-btn btn-purple";
        btn.innerHTML = `<span>üíß</span> ‡∏ß‡∏±‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô‡∏ï‡πâ‡∏ô‡∏Å‡∏•‡πâ‡∏≤`;
        btn.onclick = (e) => sendAction(moistureAction, e);
        area.appendChild(btn);
      }
    }

    function closeGridOverlay(){ document.getElementById("gridOverlay").style.display="none"; }

    async function renameSuccess(){
      const input=document.getElementById("pointNameInput");
      const name=input.value.trim();
      if(!name) return;
      const {error}=await supabaseClient.from("points").upsert({user_id:currentUser.id,x:currentPoint.x,y:currentPoint.y,name},{onConflict:['user_id','x','y']});
      if(error) console.error(error.message);
      else alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
    }

    // Upload image
    document.getElementById("pointFileInput").addEventListener("change", async(event)=>{
      const file=event.target.files[0]; if(!file) return;
      
      const fileName=`${currentUser.id}/point-${currentPoint.x}-${currentPoint.y}-${Date.now()}.${file.name.split('.').pop()}`;
      try{
        const {data,error}=await supabaseClient.storage.from("grid-images").upload(fileName,file,{cacheControl:"3600",upsert:true});
        if(error) throw error;
        const {data:publicData}=supabaseClient.storage.from("grid-images").getPublicUrl(fileName);
        const imageUrl=publicData.publicUrl;
        const img=document.getElementById("pointImage"); img.src=imageUrl; img.style.display="block";
        await supabaseClient.from("points").upsert({user_id:currentUser.id,x:currentPoint.x,y:currentPoint.y,image_url:imageUrl},{onConflict:['user_id','x','y']});
      }catch(err){ console.error(err); alert("‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à"); }
    });


    /* ===== Sidebar Control ===== */
    const sidebar = document.getElementById("sidebar");
    const overlayBg = document.getElementById("overlayBg");
    const toggle = document.getElementById("sidebarToggle");

    // ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏°‡∏ô‡∏π
    document.getElementById("menuBtn").addEventListener("click", () => {
        sidebar.classList.add("active");
        overlayBg.style.display = "block";
        toggle.checked = true;
    });

    // ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏õ‡∏¥‡∏î
    toggle.addEventListener("change", () => {
        if (!toggle.checked) {
            sidebar.classList.remove("active");
            overlayBg.style.display = "none";
        }
    });

    // ‡∏Å‡∏î‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏õ‡∏¥‡∏î‡πÄ‡∏°‡∏ô‡∏π
    overlayBg.addEventListener("click", () => {
        sidebar.classList.remove("active");
        overlayBg.style.display = "none";
        toggle.checked = false;
    });


    /* ===============================
       SEND ACTIONS
    ================================ */

    function sendAction(action, e) {
      e.preventDefault();
      const btn = e.target.closest('button'); // find button even if clicked on span

      fetch("https://yiaemxmwfxrfrwtogamw.supabase.co/rest/v1/robot_commands", {
        method: "POST",
        headers: {
          "apikey": SUPABASE_ANON_KEY,
          "Authorization": `Bearer ${SUPABASE_ANON_KEY}`,
          "Content-Type": "application/json",
          "Prefer": "return=minimal"
        },
        body: JSON.stringify({
          action: action,
          status: "pending"
        })
      })
      .then(res => {
        if (!res.ok) throw new Error("insert failed");
        alert(`‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡πÅ‡∏Ç‡∏ô‡∏Å‡∏•‡πÅ‡∏•‡πâ‡∏ß`);
        btn.disabled = true;
        btn.style.opacity = "0.5";
        btn.style.cursor = "not-allowed";
        setTimeout(() => {
          btn.disabled = false;
          btn.style.opacity = "1";
          btn.style.cursor = "pointer";
        }, 20000);
      })
      .catch(err => {
        console.error(err);
        alert("‡∏™‡πà‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ");
      });
    }

    function sendAllAction(action, btn){
      fetch("https://yiaemxmwfxrfrwtogamw.supabase.co/rest/v1/robot_commands", {
        method: "POST",
        headers: {
          "apikey": SUPABASE_ANON_KEY,
          "Authorization": `Bearer ${SUPABASE_ANON_KEY}`,
          "Content-Type": "application/json",
          "Prefer": "return=minimal"
        },
        body: JSON.stringify({
          action: action,
          status: "pending"
        })
      })
      .then(res => {
        if (!res.ok) throw new Error("insert failed");
        alert(`‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡πÅ‡∏Ç‡∏ô‡∏Å‡∏•‡πÅ‡∏•‡πâ‡∏ß`);
        btn.disabled = true;
        btn.style.opacity = "0.5";
        setTimeout(() => {
          btn.disabled = false;
          btn.style.opacity = "1";
        }, 20000);
      })
      .catch(err => {
        console.error(err);
        alert("‡∏™‡πà‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
      });
    }

    const solarSwitch = document.getElementById("solarSwitch");
    const solarStatusText = document.getElementById("solarStatus");

    solarSwitch.addEventListener("change", () => {
      if (solarSwitch.checked) {
        solarStatusText.innerText = "ON";
        sendSolarAction("OPEN");
      } else {
        solarStatusText.innerText = "OFF";
        sendSolarAction("CLOSE");
      }
    });

    function sendSolarAction(action) {
      fetch("https://yiaemxmwfxrfrwtogamw.supabase.co/rest/v1/robot_commands", {
        method: "POST",
        headers: {
          "apikey": SUPABASE_ANON_KEY,
          "Authorization": `Bearer ${SUPABASE_ANON_KEY}`,
          "Content-Type": "application/json",
          "Prefer": "return=representation"
        },
        body: JSON.stringify({
          action: action,
          status: "pending"
        })
      })
      .then(async res => {
        const text = await res.text();
        if (!res.ok) { console.error("SOLAR INSERT FAILED:", text); return; }
        console.log("SOLAR INSERT OK:", text);
      })
      .catch(err => { console.error("‡∏™‡πà‡∏á solar ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", err); });
    }

    function loadSolarStatus() {
      fetch(
        "https://yiaemxmwfxrfrwtogamw.supabase.co/rest/v1/robot_commands" +
        "?select=action,created_at" +
        "&action=in.(\"OPEN\",\"CLOSE\")" +
        "&order=created_at.desc" +
        "&limit=1",
        {
          headers: {
            "apikey": SUPABASE_ANON_KEY,
            "Authorization": `Bearer ${SUPABASE_ANON_KEY}`
          }
        }
      )
      .then(res => res.json())
      .then(data => {
        if (!data || data.length === 0) {
          solarStatusText.innerText = "---";
          return;
        }
        const action = data[0].action;
        if (action === "OPEN") {
          solarSwitch.checked = true;
          solarStatusText.innerText = "ON";
        } else if (action === "CLOSE") {
          solarSwitch.checked = false;
          solarStatusText.innerText = "OFF";
        }
      })
      .catch(err => { console.error("‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÇ‡∏ã‡∏•‡∏≤‡∏£‡πå‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", err); });
    }

    document.addEventListener("DOMContentLoaded", () => { loadSolarStatus(); });

    const client = mqtt.connect('wss://broker.hivemq.com:8884/mqtt');
    const topicSet = "Klabot/room1/light/set";
    const topicStatus = "Klabot/room1/light/status";
    const statusText = document.getElementById("status");
    const lightSwitch = document.getElementById("lightSwitch");

    client.on('connect', () => { client.subscribe(topicStatus); });
    client.on('message', (topic, message) => {
      if (topic === topicStatus) {
        const state = message.toString();
        statusText.innerText = state;
        lightSwitch.checked = (state === "ON");
      }
    });

    lightSwitch.addEventListener("change", () => {
      if (lightSwitch.checked) { client.publish(topicSet, "ON"); } 
      else { client.publish(topicSet, "OFF"); }
    });

    document.getElementById("gridOverlay").addEventListener("click", function (e) {
      e.stopPropagation();
    });

    function outsideOverlayClick(e) {
      const overlay = document.getElementById("gridOverlay");
      const seedClicked = e.target.classList.contains('seed');
      if (!overlay.contains(e.target) && !seedClicked && overlay.style.display !== 'none') {
        closeGridOverlay();
      }
    }

    let overlayMode = "detail";

    function setOverlayMode(mode) {
      overlayMode = mode;
      const chartContainer = document.getElementById("chartContainer");
      const inlineHand = document.getElementById("inlineHandArea");
      const allActionArea = document.getElementById("allActionArea");
      const detailBtn = document.getElementById("detailModeBtn");
      const handBtn = document.getElementById("handModeBtn");

      if (mode === "detail") {
        chartContainer.style.display = "block";
        inlineHand.style.display = "none";
        allActionArea.classList.remove("flex");
        allActionArea.classList.add("hidden");

        detailBtn.classList.add("active");
        detailBtn.classList.remove("inactive");
        handBtn.classList.add("inactive");
        handBtn.classList.remove("active");
      } else {
        chartContainer.style.display = "none";
        inlineHand.style.display = "flex";
        
        // Show All Action Area
        allActionArea.classList.remove("hidden");
        allActionArea.classList.add("flex");

        renderInlineHandButtons();

        handBtn.classList.add("active");
        handBtn.classList.remove("inactive");
        detailBtn.classList.add("inactive");
        detailBtn.classList.remove("active");
      }
    }

    document.addEventListener("DOMContentLoaded", () => {
      const moistureBtn = document.getElementById("allMoistureBtn");
      const waterBtn = document.getElementById("allWaterBtn");
      if (moistureBtn) { moistureBtn.onclick = (e) => { sendAction("moisture_A_all", e); }; }
      if (waterBtn) { waterBtn.onclick = (e) => { sendAction("water_A_all", e); }; }
    });

    document.getElementById("allResetBtn").addEventListener("click", () => {
      sendAllAction("RESET_A", document.getElementById("allResetBtn"));
    });

  </script>
</body>
</html>