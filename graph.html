<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏ñ‡πà‡∏≤‡∏¢‡∏ó‡∏≠‡∏î‡∏™‡∏î + ‡∏ï‡∏≤‡∏£‡∏≤‡∏á + Supabase</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css">
<style>
body { 
  font-family: Arial, sans-serif; 
  margin: 0; 
  padding: 30px; 
  background: #f3f4f6; 
  display: flex; 
  flex-direction: column; 
  align-items: center; 
}
h1 { 
  text-align: center; 
  color: #1e40af; 
  font-size: 24px; 
  font-weight: bold; 
  margin-top: 10px; 
  margin-bottom: 40px; 
}
iframe { 
  width: 640px; 
  height: 480px; 
  border: 3px solid #000; 
  border-radius: 12px; 
  margin: 20px 0; 
}
.grid-container { 
  position: relative; 
  background: white; 
  border: 1px solid #ccc; 
  margin-top: 20px; 
  margin-left: 20px; 
  max-width: 640px; 
  width: 100%; 
}
.vertical-line, .horizontal-line { 
  position: absolute; 
  background: #bbb; }
.vertical-line { 
  width: 1px; 
  top: 0; 
  bottom: 0; 
}
.horizontal-line { 
  height: 1px; 
  left: 0; 
  right: 0; 
}
.circle { 
  width: 16px; height: 16px; 
  background: #3498db; 
  border-radius: 50%; 
  transform: translate(-50%, -50%); 
  cursor: pointer;
  z-index: 5; 
  transition: background 0.5s; }
.circle:hover { 
  background: #2c7fb7; 
}
.point-container { 
  position: absolute; 
}
.tooltip { 
  position: absolute; 
  background: rgba(0,0,0,0.85); 
  color: white;
  padding: 8px; 
  border-radius: 5px; 
  font-size: 12px; 
  width: 160px; 
  text-align: center; visibility: hidden; opacity: 0; transition: opacity 0.3s; z-index: 10; }
.tooltip img { max-width: 140px; margin-top: 6px; display: block; border-radius: 4px; }
.upload-btn { display: inline-block; background: #2ecc71; color: white; padding: 4px 8px; border-radius: 3px; font-size: 11px; margin-top: 5px; cursor: pointer; }
.point-container:hover .tooltip { visibility: visible; opacity: 1; }
.tooltip input[type="text"] { width: 140px; margin-bottom: 5px; color: black; background: white; border: none; border-radius: 3px; padding: 2px 4px; }
.switch-container { display: flex; flex-direction: column; align-items: center; gap: 8px; margin-top: 30px; }
.switch-vertical { position: relative; display: inline-block; width: 44px; height: 80px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); border-radius: 44px; }
.switch-vertical input { opacity: 0; width: 0; height: 0; }
.slider-vertical { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: 0.4s; border-radius: 44px; }
.slider-vertical:before { position: absolute; content: ""; width: 36px; height: 36px; left: 4px; top: 4px; background-color: white; transition: 0.4s; border-radius: 50%; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
input:checked + .slider-vertical { background-color: #4ade80; }
input:checked + .slider-vertical:before { transform: translateY(36px); }
</style>
</head>
<body>
<div id="app" style="display:none;">
  <h1>üì∑ ‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏à‡∏≤‡∏Å ESP32-CAM</h1>
  <div class="absolute right-0 top-0 flex space-x-2 mr-4 mt-2">
    <button id="userBtn" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-lg cursor-default">‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ:</button>
    <button id="logoutBtn" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
  </div>

  <div class="content" style="display:flex;flex-wrap:wrap;gap:30px;align-items:flex-start;justify-content:center;">
    <iframe src="http://192.168.1.112" allow="camera; microphone;"></iframe>
    <div class="grid-container" id="grid"></div>
  </div>

  <div class="switch-container" style="flex-direction:row;align-items:center;justify-content:center;gap:12px;margin-top:30px;">
    <label class="switch-vertical">
      <input type="checkbox" id="lightSwitch">
      <span class="slider-vertical"></span>
    </label>
    <span id="lightStatus" style="font-weight:bold;font-size:16px;color:#1e40af;">‡πÑ‡∏ü‡∏õ‡∏¥‡∏î</span>
  </div>

  <!-- Humidity Chart Section -->
  <div style="margin-top:40px;width:100%;max-width:900px;background:white;padding:20px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.1);">
    <h2 style="color:#1e40af;margin-bottom:20px;">üíß ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô‡∏ï‡∏≤‡∏°‡πÄ‡∏ß‡∏•‡∏≤</h2>
    <div id="humidityChart" style="width:100%;height:400px;"></div>
    <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:15px;margin-top:20px;">
      <div style="background:#e0f2fe;padding:15px;border-radius:8px;text-align:center;">
        <div style="font-size:12px;color:#0369a1;">‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢</div>
        <div id="avgHumidity" style="font-size:24px;font-weight:bold;color:#0369a1;">-</div>
      </div>
      <div style="background:#dcfce7;padding:15px;border-radius:8px;text-align:center;">
        <div style="font-size:12px;color:#15803d;">‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î</div>
        <div id="maxHumidity" style="font-size:24px;font-weight:bold;color:#15803d;">-</div>
      </div>
      <div style="background:#fecdd3;padding:15px;border-radius:8px;text-align:center;">
        <div style="font-size:12px;color:#be123c;">‡∏ï‡πà‡∏≥‡∏™‡∏∏‡∏î</div>
        <div id="minHumidity" style="font-size:24px;font-weight:bold;color:#be123c;">-</div>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script>
const SUPABASE_URL = "https://yiaemxmwfxrfrwtogamw.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlpYWVteG13ZnhyZnJ3dG9nYW13Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE1MzMwOTYsImV4cCI6MjA3NzEwOTA5Nn0.I9MQPD_2LgpyELygjOroGG5qRTcwySM_t7c1o-ZvZpw";
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
let currentUser = null;

// ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡∏∞‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
(async () => {
  const { data } = await supabase.auth.getUser();
  if(!data.user) {
    window.location.href = "login.html";
    return;
  }
  currentUser = data.user;
  document.getElementById('userBtn').textContent = "‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ: " + (currentUser.email || currentUser.id);
  document.getElementById('app').style.display = "block";
  initGrid();
})();

// Logout
document.getElementById("logoutBtn").addEventListener("click", async () => {
  await supabase.auth.signOut();
  window.location.href = "login.html";
});

function initGrid() {
  const grid = document.getElementById("grid");
  const cols = 4;
  const rows = 6;
  const iframe = document.querySelector("iframe");
  const gridHeight = iframe.clientHeight;
  const cellSize = gridHeight / (rows + 1);
  grid.style.width = `${cellSize * (cols + 1)}px`;
  grid.style.height = `${gridHeight}px`;

  for(let i=1;i<=cols;i++){
    const v=document.createElement("div");
    v.className="vertical-line";
    v.style.left=`${(i/(cols+1))*100}%`;
    grid.appendChild(v);
  }
  for(let j=1;j<=rows;j++){
    const h=document.createElement("div");
    h.className="horizontal-line";
    h.style.top=`${(j/(rows+1))*100}%`;
    grid.appendChild(h);
  }

  for(let i=1;i<=cols;i++){
    for(let j=1;j<=rows;j++){
      const x=(i/(cols+1))*grid.clientWidth;
      const y=(j/(rows+1))*grid.clientHeight;
      const pointContainer=document.createElement("div");
      pointContainer.className="point-container";
      pointContainer.style.left=`${x}px`;
      pointContainer.style.top=`${y}px`;

      const circle=document.createElement("div");
      circle.className="circle";

      const tooltip=document.createElement("div");
      tooltip.className="tooltip";
      tooltip.innerHTML=`
        <div>‡∏à‡∏∏‡∏î (${i}, ${j})</div>
        <input type="text" placeholder="‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏∏‡∏î‡∏ô‡∏µ‡πâ" onchange="setName(this, ${i}, ${j})">
        <img id="img-${i}-${j}" src="" style="display:none;" alt="Image Preview">
        <label class="upload-btn">
          ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î
          <input type="file" accept="image/*" style="display:none;" onchange="uploadImage(event, ${i}, ${j})">
        </label>
      `;
      pointContainer.appendChild(circle);
      pointContainer.appendChild(tooltip);
      grid.appendChild(pointContainer);
    }
  }

  loadPoints();

  const lightSwitch=document.getElementById("lightSwitch");
  const lightStatus=document.getElementById("lightStatus");
  lightSwitch.addEventListener("change", function(){lightStatus.textContent=this.checked?"‡πÑ‡∏ü‡πÄ‡∏õ‡∏¥‡∏î":"‡πÑ‡∏ü‡∏õ‡∏¥‡∏î";});
}

async function setName(input,i,j){
  if(!currentUser) return;
  const name=input.value.trim();
  if(!name) return;
  await supabase.from("points").upsert({user_id:currentUser.id,x:i,y:j,name},{onConflict:["user_id","x","y"]});
}

async function uploadImage(event,i,j){
  if(!currentUser) return;
  const file=event.target.files[0];
  if(!file) return;
  const fileName=`${currentUser.id}/point-${i}-${j}-${Date.now()}.${file.name.split('.').pop()}`;
  try{
    const {data:errorData,error}=await supabase.storage.from("grid-images").upload(fileName,file,{cacheControl:"3600",upsert:true});
    if(error) throw error;
    const {data:publicData}=supabase.storage.from("grid-images").getPublicUrl(fileName);
    const img=document.getElementById(`img-${i}-${j}`);
    img.src=publicData.publicUrl;
    img.style.display="block";
    await supabase.from("points").upsert({user_id:currentUser.id,x:i,y:j,image_url:publicData.publicUrl},{onConflict:["user_id","x","y"]});
  }catch(err){console.error(err);alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î:\n"+err.message);}
}

async function loadPoints(){
  if(!currentUser) return;
  try{
    const {data,error}=await supabase.from("points").select("*").eq("user_id",currentUser.id);
    if(error) throw error;
    data.forEach(p=>{
      const {x,y,name,image_url}=p;
      const input=document.querySelector(`#grid input[onchange="setName(this, ${x}, ${y})"]`);
      if(input && name) input.value=name;
      const img=document.getElementById(`img-${x}-${y}`);
      if(img && image_url){img.src=image_url;img.style.display="block";}
    });
  }catch(err){console.error(err);}
  
  loadHumidityChart();
}

// Load humidity data and display chart
async function loadHumidityChart(){
  try{
    const {data,error}=await supabase.from("paintable").select("humidity, created_at").order("created_at",{ascending:true});
    if(error) throw error;
    
    if(!data || data.length === 0){
      document.getElementById('avgHumidity').textContent = '-';
      document.getElementById('maxHumidity').textContent = '-';
      document.getElementById('minHumidity').textContent = '-';
      return;
    }
    
    const humidityValues = data.map(row => parseFloat(row.humidity) || 0).filter(v => !isNaN(v));
    const timestamps = data.map(row => new Date(row.created_at).toLocaleString('th-TH'));
    
    const trace = {
      x: timestamps,
      y: humidityValues,
      type: 'scatter',
      mode: 'lines+markers',
      name: '‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô',
      line: {color: '#3b82f6', width: 2},
      marker: {size: 6, color: '#3b82f6'}
    };
    
    const layout = {
      title: '',
      xaxis: {title: '‡∏ß‡∏±‡∏ô‡πÄ‡∏ß‡∏•‡∏≤'},
      yaxis: {title: '‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô (%)'},
      hovermode: 'x unified',
      margin: {l: 50, r: 50, t: 30, b: 50}
    };
    
    Plotly.newPlot('humidityChart', [trace], layout, {responsive: true});
    
    // Update statistics
    if(humidityValues.length > 0){
      const avg = (humidityValues.reduce((a,b)=>a+b,0)/humidityValues.length).toFixed(2);
      const max = Math.max(...humidityValues).toFixed(2);
      const min = Math.min(...humidityValues).toFixed(2);
      
      document.getElementById('avgHumidity').textContent = avg + '%';
      document.getElementById('maxHumidity').textContent = max + '%';
      document.getElementById('minHumidity').textContent = min + '%';
    }
  }catch(err){console.error('Chart Error:', err);}
}

// Auto-refresh every 5 minutes
setInterval(loadHumidityChart, 5 * 60 * 1000);
</script>
</body>
</html>
