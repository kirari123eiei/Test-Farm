<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>‡∏Å‡∏£‡∏≤‡∏ü‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏£‡πà‡∏ò‡∏≤‡∏ï‡∏∏‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô‡∏Ç‡∏≠‡∏á‡∏ï‡πâ‡∏ô‡∏Å‡∏•‡πâ‡∏≤</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css">
</head>
<body class="bg-gray-50 min-h-screen p-6">
  <h2 class="text-2xl font-bold text-center mb-6 text-blue-800">
    ‡∏Å‡∏£‡∏≤‡∏ü‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏£‡πà‡∏ò‡∏≤‡∏ï‡∏∏‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô‡∏Ç‡∏≠‡∏á‡πÅ‡∏õ‡∏•‡∏á‡∏ï‡πâ‡∏ô‡∏Å‡∏•‡πâ‡∏≤
  </h2>

  <div class="absolute right-0 top-0 flex space-x-2 mr-4 mt-2">
    <button id="userBtn" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-lg cursor-default">‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ:</button>
    <button id="logoutBtn" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
  </div>

  <form id="dataForm" class="max-w-md mx-auto bg-white p-6 rounded-2xl shadow-md mb-8">
    <div class="mb-4">
      <label for="mineral" class="block font-medium text-gray-700 mb-2">‡∏Ñ‡πà‡∏≤‡πÅ‡∏£‡πà‡∏ò‡∏≤‡∏ï‡∏∏ (Mineral)</label>
      <input type="number" id="mineral" step="0.01" class="w-full border rounded-lg p-2">
    </div>

    <div class="mb-4">
      <label for="moisture" class="block font-medium text-gray-700 mb-2">‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô (Moisture)</label>
      <input type="number" id="moisture" step="0.01" class="w-full border rounded-lg p-2">
    </div>

    <div class="mb-4">
      <label for="nMineral" class="block font-medium text-gray-700 mb-2">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏ï‡∏¥‡∏°‡πÅ‡∏£‡πà‡∏ò‡∏≤‡∏ï‡∏∏‡∏ï‡πà‡∏≠‡∏ß‡∏±‡∏ô</label>
      <input type="number" id="nMineral" min="0" class="w-full border rounded-lg p-2">
    </div>

    <div class="mb-4">
      <label for="nMoisture" class="block font-medium text-gray-700 mb-2">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡∏£‡∏î‡∏ô‡πâ‡∏≥‡∏ï‡πà‡∏≠‡∏ß‡∏±‡∏ô</label>
      <input type="number" id="nMoisture" min="0" class="w-full border rounded-lg p-2">
    </div>

    <div class="flex justify-between gap-3">
      <button type="submit" class="flex-1 bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 transition">Confirm</button>
      <button type="button" id="cancelBtn" class="flex-1 bg-red-600 text-white py-2 rounded-lg hover:bg-red-700 transition">Cancel</button>
    </div>
  </form>

  <!-- ‡∏Å‡∏£‡∏≤‡∏ü‡∏´‡∏•‡∏±‡∏Å -->
  <div class="grid md:grid-cols-2 gap-6 max-w-5xl mx-auto mb-10">
    <div class="bg-white p-6 rounded-2xl shadow-md"><canvas id="lineChart"></canvas></div>
    <div class="bg-white p-6 rounded-2xl shadow-md"><canvas id="barChart"></canvas></div>
  </div>

  <!-- ‚úÖ ‡∏Å‡∏£‡∏≤‡∏ü‡πÉ‡∏´‡∏°‡πà (Realtime ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô) -->
  <div class="max-w-4xl mx-auto bg-white p-6 rounded-2xl shadow-md">
    <h3 class="text-xl font-semibold mb-3 text-center text-green-700">‡∏Å‡∏£‡∏≤‡∏ü‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô‡πÅ‡∏ö‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏•‡πÑ‡∏ó‡∏°‡πå</h3>
    <canvas id="moistureRealtimeChart"></canvas>
  </div>

  <script>
    const supabase = window.supabase.createClient(
      "https://yiaemxmwfxrfrwtogamw.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlpYWVteG13ZnhyZnJ3dG9nYW13Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE1MzMwOTYsImV4cCI6MjA3NzEwOTA5Nn0.I9MQPD_2LgpyELygjOroGG5qRTcwySM_t7c1o-ZvZpw"
    );

    let currentUser = null;
    (async () => {
      const { data } = await supabase.auth.getUser();
      if (!data.user) { window.location.href = 'login.html'; return; }
      currentUser = data.user;
      document.getElementById('userBtn').textContent = "‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ: " + (currentUser.email || currentUser.id);
      await loadData();
    })();

    document.getElementById('logoutBtn').addEventListener('click', async () => {
      await supabase.auth.signOut();
      window.location.href = 'login.html';
    });

    // === Charts setup ===
    const lineCtx = document.getElementById('lineChart').getContext('2d');
    const barCtx  = document.getElementById('barChart').getContext('2d');
    const realtimeCtx = document.getElementById('moistureRealtimeChart').getContext('2d');

    const lineData = { labels: [], datasets: [
      { label: '‡∏Ñ‡πà‡∏≤‡πÅ‡∏£‡πà‡∏ò‡∏≤‡∏ï‡∏∏ (Mineral)', data: [], borderColor: 'blue', borderWidth: 2, fill: false },
      { label: '‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô (Moisture)', data: [], borderColor: 'green', borderWidth: 2, fill: false }
    ]};
    const barData  = { labels: [], datasets: [
      { label: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏ï‡∏¥‡∏°‡πÅ‡∏£‡πà‡∏ò‡∏≤‡∏ï‡∏∏‡∏ï‡πà‡∏≠‡∏ß‡∏±‡∏ô', data: [], backgroundColor: 'orange' },
      { label: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏£‡∏î‡∏ô‡πâ‡∏≥‡∏ï‡πà‡∏≠‡∏ß‡∏±‡∏ô', data: [], backgroundColor: 'purple' }
    ]};
    const realtimeData = {
      labels: [],
      datasets: [
        { label: '‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô (Realtime)', data: [], backgroundColor: 'rgba(0, 200, 0, 0.6)' }
      ]
    };

    const lineChart = new Chart(lineCtx, { type: 'line', data: lineData, options: { responsive: true } });
    const barChart  = new Chart(barCtx,  { type: 'bar',  data: barData,  options: { responsive: true } });
    const moistureRealtimeChart = new Chart(realtimeCtx, {
      type: 'bar',
      data: realtimeData,
      options: {
        responsive: true,
        scales: { y: { beginAtZero: true } }
      }
    });

    // === Load initial data ===
    async function loadData() {
      const { data, error } = await supabase
        .from('readings')
        .select('date, mineral, moisture, n_mineral, n_moisture')
        .eq('user_id', currentUser.id)
        .order('date', { ascending: true });

      if (error) { console.error(error); alert('‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ' + error.message); return; }

      lineData.labels = data.map(r => r.date);
      lineData.datasets[0].data = data.map(r => r.mineral);
      lineData.datasets[1].data = data.map(r => r.moisture);
      barData.labels = [...lineData.labels];
      barData.datasets[0].data = data.map(r => r.n_mineral);
      barData.datasets[1].data = data.map(r => r.n_moisture);

      lineChart.update();
      barChart.update();
    }

    // === Realtime moisture chart update ===
    supabase
      .channel('realtime:readings')
      .on(
        'postgres_changes',
        { event: '*', schema: 'public', table: 'readings' },
        async (payload) => {
          console.log('üì° Realtime update:', payload);

          const row = payload.new;
          if (!row || !row.moisture) return;

          // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ô‡∏Å‡∏£‡∏≤‡∏ü realtime
          const now = new Date().toLocaleTimeString();
          realtimeData.labels.push(now);
          realtimeData.datasets[0].data.push(row.moisture);

          // ‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏à‡∏∏‡∏î‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 20 ‡∏Ñ‡πà‡∏≤
          if (realtimeData.labels.length > 20) {
            realtimeData.labels.shift();
            realtimeData.datasets[0].data.shift();
          }

          moistureRealtimeChart.update();
        }
      )
      .subscribe();

    // === Submit manually ===
    document.getElementById('dataForm').addEventListener('submit', async (event) => {
      event.preventDefault();
      const mineral   = document.getElementById('mineral').value;
      const moisture  = document.getElementById('moisture').value;
      const nMineral  = document.getElementById('nMineral').value;
      const nMoisture = document.getElementById('nMoisture').value;
      if (!mineral && !moisture && !nMineral && !nMoisture) return;

      const today = new Date();
      const yyyy = today.getFullYear();
      const mm = String(today.getMonth()+1).padStart(2,'0');
      const dd = String(today.getDate()).padStart(2,'0');
      const dateStr = `${yyyy}-${mm}-${dd}`;

      const row = {
        user_id: currentUser.id,
        date: dateStr,
        mineral: mineral ? parseFloat(mineral) : null,
        moisture: moisture ? parseFloat(moisture) : null,
        n_mineral: nMineral ? parseInt(nMineral) : null,
        n_moisture: nMoisture ? parseInt(nMoisture) : null,
      };

      const { error } = await supabase
        .from('readings')
        .upsert([row], { onConflict: 'user_id,date' });

      if (error) { alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ' + error.message); return; }

      await loadData();
      document.querySelectorAll('#dataForm input').forEach(i => i.value = "");
    });

    document.getElementById('cancelBtn').addEventListener('click', function () {
      document.querySelectorAll('#dataForm input').forEach(i => i.value = "");
    });
  </script>
</body>
</html>

