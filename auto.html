<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Auto Control</title>
<!-- Tailwind CSS -->
<script src="https://cdn.tailwindcss.com"></script>
<!-- Google Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600&display=swap" rel="stylesheet">

<style>
  body {
    font-family: 'Prompt', sans-serif;
    background-color: #f1f5f9; /* Slate-100 */
    color: #334155; /* Slate-700 */
    overflow-x: hidden;
  }

  /* --- Sidebar --- */
  #sidebar {
    position: fixed;
    top: 0;
    left: -280px;
    width: 280px;
    height: 100%;
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(10px);
    box-shadow: 4px 0 24px rgba(0,0,0,0.05);
    z-index: 60;
    transition: left 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    padding: 24px;
    display: flex;
    flex-direction: column;
  }
  #sidebar.active { left: 0; }
  
  .sidebar-link {
    display: flex;
    align-items: center;
    padding: 12px 16px;
    margin-bottom: 8px;
    border-radius: 12px;
    color: #475569;
    font-weight: 500;
    transition: all 0.2s;
  }
  .sidebar-link:hover {
    background: #eff6ff;
    color: #2563eb;
    transform: translateX(4px);
  }

  /* --- Hamburger --- */
  .hamburger-btn {
    position: fixed;
    top: 20px;
    left: 20px;
    z-index: 50;
    background: white;
    border-radius: 50%;
    width: 48px;
    height: 48px;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    cursor: pointer;
    transition: transform 0.2s;
  }
  .hamburger-btn:hover { transform: scale(1.05); }

  /* Overlay Background */
  #overlayBg {
    position: fixed;
    top:0; left:0; width:100%; height:100%;
    background: rgba(0,0,0,0.3);
    backdrop-filter: blur(2px);
    display:none;
    z-index:55;
  }

  /* --- Toggle Switch --- */
  .switch {
    position: relative;
    display: inline-block;
    width: 50px;
    height: 28px;
  }
  .switch input { opacity: 0; width: 0; height: 0; }
  .slider {
    position: absolute;
    cursor: pointer;
    top: 0; left: 0; right: 0; bottom: 0;
    background-color: #e2e8f0;
    transition: .3s cubic-bezier(0.4, 0, 0.2, 1);
    border-radius: 34px;
  }
  .slider:before {
    position: absolute;
    content: "";
    height: 22px;
    width: 22px;
    left: 3px;
    bottom: 3px;
    background-color: white;
    transition: .3s cubic-bezier(0.4, 0, 0.2, 1);
    border-radius: 50%;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }
  input:checked + .slider { background-color: #10b981; }
  input:checked + .slider:before { transform: translateX(22px); }

  /* --- Time Input Styling --- */
  .time-input {
    background: #f8fafc;
    border: 1px solid #cbd5e1;
    border-radius: 10px;
    padding: 6px 10px;
    font-size: 14px;
    color: #334155;
    outline: none;
    transition: all 0.2s;
    width: 100%;
    text-align: center;
  }
  .time-input:focus {
    border-color: #3b82f6;
    box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
  }
  .time-input:disabled {
    background: #e2e8f0;
    color: #94a3b8;
    cursor: not-allowed;
  }

  /* --- Cards --- */
  .control-card {
    background: white;
    border-radius: 20px;
    padding: 24px;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
    border: 1px solid #f1f5f9;
    height: 100%;
    transition: transform 0.2s, opacity 0.3s;
  }
  
  .function-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 0;
    border-bottom: 1px solid #f1f5f9;
  }
  .function-row:last-child { border-bottom: none; }

  /* Disabled State for Container */
  .disabled-zone {
    opacity: 0.5;
    pointer-events: none;
    filter: grayscale(0.5);
  }

  /* Save Button */
  .save-btn {
    background: linear-gradient(135deg, #2563eb, #1d4ed8);
    color: white;
    padding: 14px 40px;
    border-radius: 16px;
    font-weight: 600;
    font-size: 16px;
    box-shadow: 0 10px 20px rgba(37, 99, 235, 0.2);
    transition: all 0.2s;
    border: none;
    cursor: pointer;
    width: 100%;
    max-width: 300px;
  }
  .save-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 15px 30px rgba(37, 99, 235, 0.3);
  }
  .save-btn:active { transform: scale(0.98); }
  .save-btn.disabled {
    background: #94a3b8;
    box-shadow: none;
    cursor: not-allowed;
    transform: none;
  }

</style>
</head>
<body class="bg-slate-50">

  <!-- üîµ ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏°‡∏ô‡∏π (Hamburger) -->
  <div id="menuBtn" class="hamburger-btn">
    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#1e293b" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </div>

  <!-- üîµ SIDEBAR -->
  <div id="sidebar">
    <div class="flex justify-between items-center mb-8">
      <h2 class="text-2xl font-bold text-slate-800">Menu</h2>
      <label class="cursor-pointer" id="closeSidebarBtn">
        <input type="checkbox" id="sidebarToggle" class="hidden">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#64748b" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </label>
    </div>

    <nav class="flex-1 space-y-1">
      <a href="index.html" class="sidebar-link home">üè† ‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</a>
      <a href="camera.html" class="sidebar-link camera">ü§ñ ‡πÅ‡∏Ç‡∏ô‡∏Å‡∏• 1</a>
      <a href="camera2.html" class="sidebar-link camera2">ü§ñ ‡πÅ‡∏Ç‡∏ô‡∏Å‡∏• 2</a>
      <a href="auto.html" class="sidebar-link auto bg-blue-50 text-blue-600">‚ö° ‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</a>
      <a href="capture.html" class="sidebar-link image">üì∑ ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</a>
      <a href="FAQ.html" class="sidebar-link faq">‚ùì ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡πÜ</a>
    </nav>

    <div class="mt-auto pt-6 border-t border-slate-200">
      <div id="sidebarUsername" class="text-sm font-semibold text-slate-600 mb-3 truncate">
        ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ: -
      </div>
      <button id="sidebarLogoutBtn" class="w-full bg-red-50 hover:bg-red-100 text-red-600 py-2.5 rounded-xl font-semibold transition text-sm">
        ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
      </button>
    </div>
  </div>

  <div id="overlayBg"></div>

  <!-- üîµ MAIN CONTENT -->
  <div id="app" class="w-full max-w-5xl mx-auto px-4 py-8 md:py-12 pb-20">
    
    <header class="text-center mb-10 mt-8 md:mt-0">
      <h1 class="text-3xl md:text-4xl font-bold text-slate-800 mb-2">‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</h1>
      <p class="text-slate-500 text-sm md:text-base">‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå (Scheduler)</p>
    </header>

    <!-- Master Switch Card -->
    <div class="bg-white rounded-2xl p-6 shadow-sm border border-slate-100 mb-8 flex items-center justify-between max-w-3xl mx-auto">
      <div>
        <h2 class="text-lg font-bold text-slate-700">‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</h2>
        <p class="text-xs text-slate-400">Master Switch Control</p>
      </div>
      <label class="switch scale-110">
        <input type="checkbox" id="autoSwitch">
        <span class="slider"></span>
      </label>
    </div>

    <!-- Functions Grid -->
    <div id="autoFunctions" class="grid grid-cols-1 lg:grid-cols-3 gap-6 disabled-zone transition-all duration-300">
      
      <!-- Card 1: Robot A -->
      <div class="control-card">
        <div class="flex items-center gap-3 mb-6">
          <div class="p-2 bg-green-100 text-green-600 rounded-lg">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4M4.93 19.07l2.83-2.83M16.24 7.76l2.83-2.83"/></svg>
          </div>
          <h3 class="font-bold text-slate-700 text-lg">‡πÅ‡∏Ç‡∏ô‡∏Å‡∏• 1 (Zone A)</h3>
        </div>
        
        <div class="space-y-4">
          <!-- Moisture A -->
          <div class="flex flex-col gap-2">
            <div class="flex justify-between items-center">
              <span class="text-sm font-medium text-slate-600">üíß ‡∏ß‡∏±‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô</span>
              <label class="switch">
                <input type="checkbox" id="moistureA">
                <span class="slider"></span>
              </label>
            </div>
            <input type="time" id="moistureTimeA" class="time-input" disabled>
          </div>

          <div class="border-b border-slate-100 my-2"></div>

          <!-- Water A -->
          <div class="flex flex-col gap-2">
            <div class="flex justify-between items-center">
              <span class="text-sm font-medium text-slate-600">üöø ‡∏£‡∏î‡∏ô‡πâ‡∏≥‡∏ï‡πâ‡∏ô‡∏Å‡∏•‡πâ‡∏≤</span>
              <label class="switch">
                <input type="checkbox" id="waterA">
                <span class="slider"></span>
              </label>
            </div>
            <input type="time" id="waterTimeA" class="time-input" disabled>
          </div>
        </div>
      </div>

      <!-- Card 2: Robot B -->
      <div class="control-card">
        <div class="flex items-center gap-3 mb-6">
          <div class="p-2 bg-blue-100 text-blue-600 rounded-lg">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="3" width="20" height="14" rx="2" ry="2"></rect><line x1="8" y1="21" x2="16" y2="21"></line><line x1="12" y1="17" x2="12" y2="21"></line></svg>
          </div>
          <h3 class="font-bold text-slate-700 text-lg">‡πÅ‡∏Ç‡∏ô‡∏Å‡∏• 2 (Zone B)</h3>
        </div>

        <div class="space-y-4">
          <!-- Moisture B -->
          <div class="flex flex-col gap-2">
            <div class="flex justify-between items-center">
              <span class="text-sm font-medium text-slate-600">üíß ‡∏ß‡∏±‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô</span>
              <label class="switch">
                <input type="checkbox" id="moistureB">
                <span class="slider"></span>
              </label>
            </div>
            <input type="time" id="moistureTimeB" class="time-input" disabled>
          </div>

          <div class="border-b border-slate-100 my-2"></div>

          <!-- Water B -->
          <div class="flex flex-col gap-2">
            <div class="flex justify-between items-center">
              <span class="text-sm font-medium text-slate-600">üöø ‡∏£‡∏î‡∏ô‡πâ‡∏≥‡∏ï‡πâ‡∏ô‡∏Å‡∏•‡πâ‡∏≤</span>
              <label class="switch">
                <input type="checkbox" id="waterB">
                <span class="slider"></span>
              </label>
            </div>
            <input type="time" id="waterTimeB" class="time-input" disabled>
          </div>
        </div>
      </div>

      <!-- Card 3: Others -->
      <div class="control-card">
        <div class="flex items-center gap-3 mb-6">
          <div class="p-2 bg-purple-100 text-purple-600 rounded-lg">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
          </div>
          <h3 class="font-bold text-slate-700 text-lg">‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡πÜ</h3>
        </div>

        <div class="space-y-4">
          <!-- Light -->
          <div class="flex flex-col gap-2">
            <div class="flex justify-between items-center">
              <span class="text-sm font-medium text-slate-600">üí° ‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏ü‡∏™‡πà‡∏≠‡∏á‡∏™‡∏ß‡πà‡∏≤‡∏á</span>
              <label class="switch">
                <input type="checkbox" id="lightOnSwitch">
                <span class="slider"></span>
              </label>
            </div>
            <div class="flex items-center gap-2">
              <input type="time" id="lightOnTime" class="time-input" disabled>
              <span class="text-xs text-slate-400">‡∏ñ‡∏∂‡∏á</span>
              <input type="time" id="lightOffTime" class="time-input" disabled>
            </div>
          </div>

          <div class="border-b border-slate-100 my-2"></div>

          
          <!-- ... ‡∏™‡πà‡∏ß‡∏ô‡∏à‡∏ö‡∏Ç‡∏≠‡∏á Card 3 (Solar) ... -->
          <div class="flex flex-col gap-2">
            <div class="flex justify-between items-center">
              <span class="text-sm font-medium text-slate-600">‚òÄÔ∏è ‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡πÇ‡∏ã‡∏•‡∏≤‡∏£‡πå‡πÄ‡∏ã‡∏•‡∏•‡πå</span>
              <label class="switch">
                <input type="checkbox" id="solarSwitch">
                <span class="slider"></span>
              </label>
            </div>
            <div class="flex items-center gap-2">
              <input type="time" id="solarOnTime" class="time-input" disabled>
              <span class="text-xs text-slate-400">‡∏ñ‡∏∂‡∏á</span>
              <input type="time" id="solarOffTime" class="time-input" disabled>
            </div>
          </div>
        </div> <!-- ‡∏õ‡∏¥‡∏î space-y-4 -->
      </div> <!-- ‡∏õ‡∏¥‡∏î control-card -->

    </div> <!-- üî¥üî¥ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏±‡∏ß‡∏ô‡∏µ‡πâ‡∏Ñ‡∏£‡∏±‡∏ö! (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏¥‡∏î autoFunctions Grid) üî¥üî¥ -->

    <!-- Save Button -->
    <div class="mt-10 flex justify-center w-full">
      <button id="saveBtn" class="save-btn disabled">
        ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤
      </button>
    </div>

  </div>

  <footer class="text-center py-6 text-slate-400 text-xs">
    &copy; 2025 Klabot Dev Team. All rights reserved.
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
    const SUPABASE_URL = "https://yiaemxmwfxrfrwtogamw.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlpYWVteG13ZnhyZnJ3dG9nYW13Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE1MzMwOTYsImV4cCI6MjA3NzEwOTA5Nn0.I9MQPD_2LgpyELygjOroGG5qRTcwySM_t7c1o-ZvZpw";
    const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    let currentUser = null;

    // ‡πÄ‡∏ä‡πá‡∏Ñ user
    async function checkUser(){
      const { data: { session } } = await supabaseClient.auth.getSession();
      if(!session || !session.user){ window.location.href="login.html"; return; }
      currentUser = session.user;
      document.getElementById("sidebarUsername").textContent = `‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ: ${currentUser.email}`;
      document.getElementById("app").style.display="block";
      loadAutoTasks();
    }
    checkUser();

    // logout
    document.getElementById("sidebarLogoutBtn").addEventListener("click", async ()=>{
      const {error} = await supabaseClient.auth.signOut();
      if(error) console.error(error.message); else window.location.href="login.html";
    });

    /* ===== Sidebar Control ===== */
    const sidebar = document.getElementById("sidebar");
    const overlayBg = document.getElementById("overlayBg");
    const toggle = document.getElementById("sidebarToggle");

    document.getElementById("menuBtn").addEventListener("click", () => {
        sidebar.classList.add("active");
        overlayBg.style.display = "block";
        toggle.checked = true;
    });

    toggle.addEventListener("change", () => {
        if (!toggle.checked) {
            sidebar.classList.remove("active");
            overlayBg.style.display = "none";
        }
    });

    overlayBg.addEventListener("click", () => {
        sidebar.classList.remove("active");
        overlayBg.style.display = "none";
        toggle.checked = false;
    });

    /***********************
     * AUTO SYSTEM CONTROL
     ***********************/
    const autoSwitch    = document.getElementById("autoSwitch");
    const autoFunctions = document.getElementById("autoFunctions");
    const saveBtn       = document.getElementById("saveBtn");

    /* ===== ‡πÄ‡∏õ‡∏¥‡∏î / ‡∏õ‡∏¥‡∏î ‡∏£‡∏∞‡∏ö‡∏ö ===== */
    autoSwitch.addEventListener("change", async () => {
      if (!currentUser) {
        alert("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ login");
        autoSwitch.checked = false;
        return;
      }

      if (autoSwitch.checked) {
        autoFunctions.classList.remove("disabled-zone");
        saveBtn.classList.remove("disabled");
      } else {
        autoFunctions.classList.add("disabled-zone");
        saveBtn.classList.add("disabled");

        await supabaseClient
          .from("auto_tasks")
          .update({ enable: false })
          .eq("user_id", currentUser.id);
      }
    });

    /***********************
     * BIND CHECKBOX ‚Üí TIME
     ***********************/
    function bindTime(cbId, timeId) {
      const cb   = document.getElementById(cbId);
      const time = document.getElementById(timeId);
      if (!cb || !time) return;

      time.disabled = !cb.checked;

      cb.addEventListener("change", () => {
        time.disabled = !cb.checked;
        if (!cb.checked) time.value = "";
      });
    }

    bindTime("moistureA", "moistureTimeA");
    bindTime("waterA", "waterTimeA");
    bindTime("moistureB", "moistureTimeB");
    bindTime("waterB", "waterTimeB");
    // bindTime("solarSwitch", "solarTime"); // ‚ùå ‡∏≠‡∏±‡∏ô‡πÄ‡∏Å‡πà‡∏≤‡∏•‡∏ö‡∏≠‡∏≠‡∏Å

    /* Light Control */
    const lightOnSwitch = document.getElementById("lightOnSwitch");
    const lightOnTime   = document.getElementById("lightOnTime");
    const lightOffTime  = document.getElementById("lightOffTime");

    lightOnSwitch.addEventListener("change", () => {
      const enabled = lightOnSwitch.checked;
      lightOnTime.disabled  = !enabled;
      lightOffTime.disabled = !enabled;
      if (!enabled) {
        lightOnTime.value  = "";
        lightOffTime.value = "";
      }
    });

    /* Solar Control (NEW ‚úÖ) */
    const solarSwitch  = document.getElementById("solarSwitch");
    const solarOnTime  = document.getElementById("solarOnTime");
    const solarOffTime = document.getElementById("solarOffTime");

    solarSwitch.addEventListener("change", () => {
      const enabled = solarSwitch.checked;
      solarOnTime.disabled  = !enabled;
      solarOffTime.disabled = !enabled;
      if (!enabled) {
        solarOnTime.value  = "";
        solarOffTime.value = "";
      }
    });

    /***********************
     * SAVE DATA
     ***********************/
    saveBtn.addEventListener("click", async () => {
      if (!currentUser) { alert("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ login"); return; }
      if (saveBtn.classList.contains('disabled')) return;

      const rows = [];

      // ‡πÄ‡∏û‡∏¥‡πà‡∏° parameter solar_state ‡πÅ‡∏•‡∏∞ light_state
      function addTask({ arm, measure, water, solarcell, solar_state, light_state, hour, minute }) {
        rows.push({
          enable: true,
          arm: arm ?? null,
          measure: measure ?? null,
          water: water ?? null,
          solarcell: solarcell ?? null,
          solar_state: solar_state ?? null, // ‡πÄ‡∏û‡∏¥‡πà‡∏° column ‡∏ô‡∏µ‡πâ‡πÉ‡∏ô DB ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ
          light_state: light_state ?? null,
          hour,
          minute,
          user_id: currentUser.id
        });
      }

      /* ‡πÅ‡∏Ç‡∏ô‡∏Å‡∏• A */
      if (moistureA.checked && moistureTimeA.value) {
        const [h, m] = moistureTimeA.value.split(":").map(Number);
        addTask({ arm: "A", measure: true, hour: h, minute: m });
      }
      if (waterA.checked && waterTimeA.value) {
        const [h, m] = waterTimeA.value.split(":").map(Number);
        addTask({ arm: "A", water: true, hour: h, minute: m });
      }

      /* ‡πÅ‡∏Ç‡∏ô‡∏Å‡∏• B */
      if (moistureB.checked && moistureTimeB.value) {
        const [h, m] = moistureTimeB.value.split(":").map(Number);
        addTask({ arm: "B", measure: true, hour: h, minute: m });
      }
      if (waterB.checked && waterTimeB.value) {
        const [h, m] = waterTimeB.value.split(":").map(Number);
        addTask({ arm: "B", water: true, hour: h, minute: m });
      }

      /* ‡πÑ‡∏ü */
      if (lightOnSwitch.checked) {
        if (!lightOnTime.value || !lightOffTime.value) {
          alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏•‡∏∞‡∏õ‡∏¥‡∏î‡πÑ‡∏ü");
          return;
        }
        const [onH, onM] = lightOnTime.value.split(":").map(Number);
        addTask({ light_state: "ON", hour: onH, minute: onM });

        const [offH, offM] = lightOffTime.value.split(":").map(Number);
        addTask({ light_state: "OFF", hour: offH, minute: offM });
      }

      /* ‡πÇ‡∏ã‡∏•‡∏≤‡∏£‡πå‡πÄ‡∏ã‡∏•‡∏•‡πå (NEW ‚úÖ) */
      if (solarSwitch.checked) {
        if (!solarOnTime.value || !solarOffTime.value) {
          alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏•‡∏∞‡∏õ‡∏¥‡∏î‡πÇ‡∏ã‡∏•‡∏≤‡∏£‡πå‡πÄ‡∏ã‡∏•‡∏•‡πå");
          return;
        }
        // ‡πÄ‡∏õ‡∏¥‡∏î (OPEN)
        const [onH, onM] = solarOnTime.value.split(":").map(Number);
        addTask({ solarcell: true, solar_state: "OPEN", hour: onH, minute: onM });

        // ‡∏õ‡∏¥‡∏î (CLOSE)
        const [offH, offM] = solarOffTime.value.split(":").map(Number);
        addTask({ solarcell: true, solar_state: "CLOSE", hour: offH, minute: offM });
      }

      if (rows.length === 0) {
        alert("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏≠‡∏∞‡πÑ‡∏£");
        return;
      }

      /* ‡∏õ‡∏¥‡∏î‡∏Ç‡∏≠‡∏á‡πÄ‡∏Å‡πà‡∏≤ */
      await supabaseClient.from("auto_tasks").update({ enable: false }).eq("user_id", currentUser.id);

      /* Insert ‡πÉ‡∏´‡∏°‡πà */
      const { error } = await supabaseClient.from("auto_tasks").insert(rows);
      if (error) { 
        console.error(error); 
        // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤ Error ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡πÑ‡∏°‡πà‡∏°‡∏µ column solar_state ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
        alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á Database)"); 
        return; 
      }

      alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
    });

    /***********************
     * LOAD DATA
     ***********************/
    async function loadAutoTasks() {
      if (!currentUser) return;

      const { data, error } = await supabaseClient
        .from("auto_tasks")
        .select("*")
        .eq("user_id", currentUser.id)
        .eq("enable", true);

      if (error || !data || data.length === 0) return;

      autoSwitch.checked = true;
      autoFunctions.classList.remove("disabled-zone");
      saveBtn.classList.remove("disabled");

      data.forEach(task => {
        const timeValue = String(task.hour).padStart(2, "0") + ":" + String(task.minute).padStart(2, "0");

        if (task.arm === "A" && task.measure) {
          moistureA.checked = true; moistureTimeA.disabled = false; moistureTimeA.value = timeValue;
        }
        if (task.arm === "A" && task.water) {
          waterA.checked = true; waterTimeA.disabled = false; waterTimeA.value = timeValue;
        }
        if (task.arm === "B" && task.measure) {
          moistureB.checked = true; moistureTimeB.disabled = false; moistureTimeB.value = timeValue;
        }
        if (task.arm === "B" && task.water) {
          waterB.checked = true; waterTimeB.disabled = false; waterTimeB.value = timeValue;
        }

        // Light
        if (task.light_state === "ON") {
          lightOnSwitch.checked = true;
          lightOnSwitch.dispatchEvent(new Event("change"));
          lightOnTime.value = timeValue;
        }
        if (task.light_state === "OFF") {
          lightOffTime.value = timeValue;
        }

        // Solar (NEW ‚úÖ)
        if (task.solarcell) {
          solarSwitch.checked = true;
          solarSwitch.dispatchEvent(new Event("change"));
          
          if (task.solar_state === "OPEN") {
            solarOnTime.value = timeValue;
          }
          if (task.solar_state === "CLOSE") {
            solarOffTime.value = timeValue;
          }
        }
      });
    }
</script>

  </script>
</body>
</html>